<!DOCTYPE html>
<!-- this document is auto-generated from pankat document editor -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head data-article-dst-filename="NAT_IPv4_holepunching_nattraversal.html">

<meta charset="utf-8" />
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>NAT IPv4 holepunching nattraversal</title>

<script src="js/jquery.min.js"></script>

<script src="js/jquery-ui-1.9.1.custom.min.js"></script>
<script src="js/jquery.tocify.min.js"></script>

<link type="text/css" rel="stylesheet" href="css/jquery.tocify.css" />



<script src="js/reconnecting-websocket.min.js"></script>
<script src="js/pankat-websocket.js"></script>
<script src="js/diffDOM.js"></script>


<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
<script src="js/bootstrap.min.js"></script>

<script src="js/anchor.min.js"></script>

<link rel="icon" href="media/favicon.ico" type="image/x-icon" />


<!--[if lt IE 9]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
<![endif]-->
<link rel="stylesheet" href="css/pandoc-kate.css" type="text/css" />
<link rel="stylesheet" href="css/style.css" type="text/css" />

</head>
<body>

<div id="toc"></div>

<!-- menu begins -->
<div class="container">
  <nav class="navbar navbar-default">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">lastlog.de/blog</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="timeline.html"><span class="glyphicon glyphicon-list" aria-hidden="true"></span> timeline</a></li>
        <li><a href="about.html"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> about</a></li>
        <li><a href="/draft" id="draft" style="display: none"><span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span> draft</a></li>
        <li><a href="/draft?article=posts/roadmap.mdwn" id="roadmap" style="display: none"><span class="glyphicon glyphicon glyphicon-road" aria-hidden="true"></span> roadmap</a></li>

      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a title="live updates of article updates on posts/NAT_IPv4_holepunching_nattraversal.mdwn" id="websocket" style="display: none"><span id="websocketStatus" class="glyphicon glyphicon-remove" aria-hidden="true"></span> websocket</a></li>
        <!-- <li><a href="#">Login</a></li> -->
      </ul>

      <!--<div id="right">
        <form class="navbar-form navbar-right">
          <div class="form-group">
            <input type="text" class="form-control" placeholder="Search">
          </div>
        </form>
      </div>-->
    </div><!-- /.navbar-collapse -->
  </nav>

<div id="headerAndArticle">


  <div id="headerContainer">
    <header class="header"><span id="articleNavLeft"> <a href="openstreetmap_heightmaps.html"> 
      <span class="glyphiconLink glyphicon glyphicon-chevron-left" aria-hidden="true" title="previous article"> </span> prev. article
    </a> </span><span id="articleNavRight"><a href="installing_murmurd_mumble_bypassing_packet_management.html"> 
        next article <span class="glyphiconLink glyphicon glyphicon-chevron-right" aria-hidden="true" title="next article"></span>
    </a> </span></header>
  </div>
  

  <div class="article">
    <h1 id="SiteTitle">NAT IPv4 holepunching nattraversal</h1>
    <div id="date"><p><span id="lastupdated">8 oct 2009</span></p></div><div id="tags"><p><a href="timeline.html?filter=tag::linux" class="tagbtn btn btn-primary">linux</a><a href="timeline.html?filter=tag::taspring" class="tagbtn btn btn-primary">taspring</a><a href="timeline.html?filter=tag::tcp" class="tagbtn btn btn-primary">tcp</a><a href="timeline.html?filter=tag::technology" class="tagbtn btn btn-primary">technology</a><a href="timeline.html?filter=tag::usability" class="tagbtn btn btn-primary">usability</a></p></div>
    <p>today i wanted to play a game of spring [1] with a friend but it
<strong>didn’t work</strong>. i was using windows xp (not linux but yes
this is even more <em>usual</em> there) and i downloaded spring with the
nice little lobby called ‘springlobby’. i even remembered my login for
the lobby interface. after connecting we wanted to use skype which
didn’t work for about <strong>15minutes</strong> (yes i was using my
linux laptop and the sound there usually suckz as it tends to block the
soundcard for some unknown reason quite often). but the problem was also
the <strong>new account</strong> on the other end which <em>had to be
created</em> but which didn’t work. after a couple of skype restarts on
both sides it was starting to work. (not mentioning the issue of adding
a new contact…).</p>
<p>so the lobby was running and we could talk using skype, <strong>what
else could go wrong?</strong></p>
<p>right after wards i hosted a game (i didn’t expect it to work since i
didn’t do any manual port forwarding for the kind of random ip i usually
have). i didn’t see the <strong>‘nat traversal’ </strong>option in
springlobby first (because i tend to join other games instead of hosting
exactly for this kind of issue). so the game failed but to detect it -
especially if several ppl join your game - you have to launch the game.
so the game starts in fullscreen (it’s an opengl application) and
computes some routes (waypoints or whatever) which is important for the
ai (also for the own units) for pathfinding. waiting about 40 seconds to
see that the connection didn’t work.</p>
<p>so next i rehosted the game using <strong>‘nat traversal’</strong>
clicked. but it didn’t work either. no error message and no diagnostics
of the issue. just a silent fail - which is what i tend to hate most
(except a silent fail after a timeout which i even hate more).</p>
<p>finally my friend tried to host a game (he is also behind NAT - but
who is not nowadays?). of course the same problem - it didn’t work. but
skype once the audio part worked keept working. skype managed to
traverse the NAT (or at least was using a relay we didn’t know of -
which is the usual fallback used by skype, see [2]).</p>
<p>this reminded me however of the solution for this problem i was
thinking of quite some time ago when i wrote a lobbyclient myself [3]
together with two friends.</p>
<p>the question is: <strong>“how to establish a connection before game
launch?”</strong></p>
<p>two answer this question we will have a look at how a game launch
works right now.</p>
<ol type="1">
<li>using <strong>springlobby</strong> to <strong>connect the the
tasserver</strong> (that is the springlobby server which hosts the chat
and the game preparation - a chatroom exchanging the gamedetails as
map/teams and the ip of the server)</li>
<li>in springlobby creating new game -&gt; <strong>‘host a
game’</strong></li>
<li>other players see this game in a list and join it (the tasprotocol
is quite ugly but this is not of interest now)</li>
<li>now every player (not the hoster) has to click
<strong>‘ready’</strong></li>
<li>finally the game is launched by the hoster (the administrator of the
game) and the hoster sends it’s <strong>IP</strong> along with a
<strong>UDP Port</strong> to the other players.</li>
<li>now a config file is created in every client, a special config is
created for the hoster (hoster = server)</li>
<li>the clients try to connect to the hoster (if the hoster isn’t
already done with starting the game, which can take a while as seen
above, the clients reconnect every few secons until a timeout of 40
seconds is reached). please note that while the player is waiting for
that timeout he can’t read the chat log since he is already ingame which
is usability wise a horrible thing to do. you can’t inform the player
that the game won’t work (in case you know that already for some
reason)</li>
<li>now after the hoster managed to start the game the clients connect
and the player label color changes from red (not connection yet) to
green (player has successfully connected)</li>
<li>in case every player is connected … the game can start</li>
</ol>
<p>say the game connection didn’t work for at least one player and say
an average game is joined by 4-8 ppl. please think of the time each
player has to wait in average to detect a network issue. believe me
‘<strong>it is a lot of time</strong>’ and this made the ‘autohost’
function very popular.</p>
<p>the <strong>autohost</strong> is a game hosted by a nice person which
has a computer running 24/7 with some game starter script. if a
programmed <strong>bot</strong> in the gameroom parses the chat of the
players and detects some string as “<strong>!start</strong>” from the
‘virtual hoster’ the game is launched and <strong>spring.exe</strong>
starts (that is the game binary). since spring.exe can’t be run
dedicated it is not only a waste of power/bandwidth but also a waste of
workspace. i expect the game to be run in the background but still this
has lots of performance loss for the user.</p>
<p>autohosting is a nice thing for players but it seems - at least for
me - be more like a workaround for a technological problem not solved
properly.</p>
<p><strong>the fix i was talking of is this:</strong></p>
<p>when the ‘hoster’ is hosting a game the ‘hoster’ starts a udp-server
on a random <strong>port</strong> (which is known after starting the
server of course). the <strong>ip</strong> and <strong>port</strong> are
then automatically given to the other players. now every player tries to
connect to that ip:port right away without launching spring.exe and
without creating a configuration file. if the connection from player to
the hoster is working a green LED in the springlobby will light up and
everyone sees the status immediately. when the game launches every
<strong>client then connects</strong> - not the the hoster ip:port - but
instead to <strong>localhost:port</strong>.</p>
<p>so now we need a tiny relay udp server with hole punching
capabilities and as some might like UPnP network capabilities.</p>
<p>client1 (192.168.1.22) –lan– fritz!box (192.168.1.1) —– inet
—————–many routers —————— inet —– fritz!box (192.168.1.1) —-lan— client2
(192.168.1.33)</p>
<p>as you can see both clients reside in the same subnets but this is no
issue since both subnets <strong>(192.168.1.x/24)</strong> are in an
<strong>address space</strong> which <strong>isn’t routed</strong> in
the <strong>ipv4</strong> internet definition and since both clients are
routed by a router (fritzbox in this case, can be any other vendor as
well) both are behind NAT (network address translation) - which is our
problem in the first place.</p>
<p>our small udpserver (i call it “<strong>udpPuncher</strong>”) would
require:</p>
<ul>
<li>relaying udp packets from one ip to another, no parsing of the udp
packets at all</li>
<li>libNAT (to have UPnP capabilities)</li>
<li>holepunching (a udp nat traversal technique which is quite
common)</li>
<li>and some interface (either a socket or a dbus like interface) to
control and query the relay</li>
<li>some easy logic to report to the springlobby that the playerX has
successfully connected to the hoster</li>
</ul>
<p>so you might say that is <strong>no new technology</strong>.</p>
<ul>
<li>maybe not but don’t forget that most games are hosted by expensive
servers (battle.net from blizzard or others). some games have a
dedicated client (very often a even a linux client) you can install and
run on a internetserver which is not behind a NAT and which has lots of
bandwidth (most important aspect here is the <strong>upload speed
</strong>and <strong>latency</strong>).</li>
</ul>
<p>i’ve never seen such a udpserver or library. all i know are a couple
of projects trying to solve that issue. take sip as an example - they
have the same problem there and they often give you a <strong>stun
server</strong> (udp holepunching) to relay connection
establishment.</p>
<p>there was a nice project i came along [4] which checked the NAT
capabilities of your own network (there was a linux and a windows
client). i’m not sure about the results but this could be used to
qualify the network NAT type in an attempt to write the not yet written
<strong>udpPuncher</strong>.</p>
<p><strong>ipv6</strong> would be a nice solution but i doubt this will
be here soon as nobody seems to have interest in ipv6.</p>
<p>#links * [1] <a href="http://springrts.com"
class="uri">http://springrts.com</a> * [2] <a
href="http://en.wikipedia.org/wiki/Skype_protocol"
class="uri">http://en.wikipedia.org/wiki/Skype_protocol</a> * [3] <a
href="http://code.google.com/p/qtlobby/"
class="uri">http://code.google.com/p/qtlobby/</a> * [4] <a
href="http://nattest.net.in.tum.de/?mod=infos&amp;lan=de"
class="uri">http://nattest.net.in.tum.de/?mod=infos&amp;lan=de</a></p>
<p><strong>UPDATE:</strong></p>
<p>I just found out that [4] is not new at all (maybe it is but not but
at least for me it is), i’ve read [5] some long time ago but didn’t
remember it. Now here is a very <strong>detailed documentation</strong>
about <strong>NAT</strong> with illustrated (but not animated ;-P)
examples of usage:</p>
<ul>
<li>[5] <a href="http://www.brynosaurus.com/pub/net/p2pnat/"
class="uri">http://www.brynosaurus.com/pub/net/p2pnat/</a></li>
</ul>

  </div>

</div>

<div id="ArticleSourceCode">

<a href="posts/NAT_IPv4_holepunching_nattraversal.mdwn" title="posts\NAT_IPv4_holepunching_nattraversal.mdwn">article source</a>
</div>

</div>

<div id="scrollUp">
<span id="scrollUpBtn" class="glyphiconLink glyphicon glyphicon-chevron-up" aria-hidden="true" title="scroll up"></span>
</div>

<script>
$("#scrollUpBtn").click(function() {
  $("html, body").animate({ scrollTop: 0 }, "slow");
  return false;
});
</script>


<script>
window.onload = function(e){
  anchors.add('h1')
  anchors.add('h2')
  anchors.add('h3')
  anchors.add('h4')
  anchors.add('h5')
}
</script>




<script>
$(document).ready(function() {
  //Calls the tocify method on your HTML div.
  $("#toc").tocify();
});
$("#toc").hover(function() {
  $("#toc").css("z-index", "111")
}, function() {
  $("#toc").css("z-index", "1")
});
</script>



<script>

var shifted = false;

$(window).keyup(function(event) {
    shifted = event.shiftKey;
});

$(window).keydown(function(event) {
  if(event.keyCode == 16){
    shifted = event.shiftKey;
  }
  if (shifted == false) {
      if(event.keyCode == 37){
        $('.glyphicon-chevron-left')[0].click()
      }
      if(event.keyCode == 39){
        $('.glyphicon-chevron-right')[0].click()
      }
  }
});
</script>


<script>
// check if we got served from pankat-server
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
  if (xhr.status == 200) {
    console.log("request to /pankat-server returned status: " + xhr.status + ", so yes we got served from pankat-server");
    $('#draft').css("display", "block");
    $('#roadmap').css("display", "block");
  }
}
}
xhr.open('GET', "/pankat-server", false);
xhr.send(null);
</script>
</body>
</html>
