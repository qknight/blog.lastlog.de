<!DOCTYPE html>
<!-- this document is auto-generated from pankat document editor -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head data-article-dst-filename="nixcloud-webservices_tests.html">

<meta charset="utf-8" />
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>nixcloud-webservices tests</title>

<script src="js/jquery.min.js"></script>

<script src="js/jquery-ui-1.9.1.custom.min.js"></script>
<script src="js/jquery.tocify.min.js"></script>

<link type="text/css" rel="stylesheet" href="css/jquery.tocify.css" />



<script src="js/reconnecting-websocket.min.js"></script>
<script src="js/pankat-websocket.js"></script>
<script src="js/diffDOM.js"></script>


<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
<script src="js/bootstrap.min.js"></script>

<script src="js/anchor.min.js"></script>

<link rel="icon" href="media/favicon.ico" type="image/x-icon" />


<!--[if lt IE 9]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
<![endif]-->
<link rel="stylesheet" href="css/pandoc-kate.css" type="text/css" />
<link rel="stylesheet" href="css/style.css" type="text/css" />

</head>
<body>

<div id="toc"></div>

<!-- menu begins -->
<div class="container">
  <nav class="navbar navbar-default">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">lastlog.de/blog</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="timeline.html"><span class="glyphicon glyphicon-list" aria-hidden="true"></span> timeline</a></li>
        <li><a href="about.html"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> about</a></li>
        <li><a href="/draft" id="draft" style="display: none"><span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span> draft</a></li>
        <li><a href="/draft?article=posts/roadmap.mdwn" id="roadmap" style="display: none"><span class="glyphicon glyphicon glyphicon-road" aria-hidden="true"></span> roadmap</a></li>

      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a title="live updates of article updates on posts/nixcloud-webservices_tests.mdwn" id="websocket" style="display: none"><span id="websocketStatus" class="glyphicon glyphicon-remove" aria-hidden="true"></span> websocket</a></li>
        <!-- <li><a href="#">Login</a></li> -->
      </ul>

      <!--<div id="right">
        <form class="navbar-form navbar-right">
          <div class="form-group">
            <input type="text" class="form-control" placeholder="Search">
          </div>
        </form>
      </div>-->
    </div><!-- /.navbar-collapse -->
  </nav>

<div id="headerAndArticle">


  <div id="headerContainer">
    <header class="header"><span id="articleNavLeft"> <a href="nixcloud-webservices.html"> 
      <span class="glyphiconLink glyphicon glyphicon-chevron-left" aria-hidden="true" title="previous article"> </span> prev. article
    </a> </span><span id="articleNavRight"><a href="nix-language-atlas_javascript.html"> 
        next article <span class="glyphiconLink glyphicon glyphicon-chevron-right" aria-hidden="true" title="next article"></span>
    </a> </span></header>
  </div>
  
      <div id="seriesContainer">
      <a href="timeline.html?filter=series::nixcloud" title="article series nixcloud" class="seriesbtn btn btn-primary">nixcloud</a>
        <header class="seriesHeader">
          <div id="seriesLeft"><a href="nixcloud-webservices.html"><span class="glyphiconLinkSeries glyphicon glyphicon-chevron-left" aria-hidden="true" title="previous article in series"></span>
            </a>   </div>
          <div id="seriesRight">   <a href="docker_compose_vs_nixcloud.html">
              <span class="glyphiconLinkSeries glyphicon glyphicon-chevron-right" aria-hidden="true" title="next article in series"></span>
            </a></div>
        </header>
      </div>

  <div class="article">
    <h1 id="SiteTitle">nixcloud-webservices tests</h1>
    <div id="date"><p><span id="lastupdated">28 nov 2017</span></p></div><div id="tags"><p><a href="timeline.html?filter=tag::nixos" class="tagbtn btn btn-primary">nixos</a><a href="timeline.html?filter=tag::nixcloud" class="tagbtn btn btn-primary">nixcloud</a><a href="timeline.html?filter=tag::tests" class="tagbtn btn btn-primary">tests</a></p></div>
    <p><a href="media/nixcloud.png"><img src=media/nixcloud.png size=10x class="noFancy" style="float: right"></a></p>
<h2 data-number="1" id="motivation">motivation</h2>
<p>many programming languages have testing frameworks and for sometimes
they are even used. in nixpkgs i see them lots, most often in libraries
written in <code>perl</code>, <code>python</code> and
<code>go</code>.</p>
<p>this posting is about how we adapted this concept into nix. AFAIK
this hasn’t been done before so it might be worth sharing.</p>
<h2 data-number="2" id="how-testing-works-in-perlpythongo">how testing
works in perl/python/go</h2>
<p>the tests are executed during the build of the software and most
often implemented in libraries.</p>
<p>sometimes there is <code>doCheck = false;</code> as the tests fail
for some reason. often these tests are impure and the build environment
can’t perform the actions, as for instance, visiting some remote website
during build time which is not possible in a nix-build phase.</p>
<p>testing systems i’m refering to:</p>
<ul>
<li><a href="http://www.jmdeldin.com/bioinf/testing/index.html">perl
example</a></li>
<li><a
href="http://docs.python-guide.org/en/latest/writing/tests/">python
example</a></li>
<li><a href="https://golang.org/pkg/testing/">go example</a></li>
</ul>
<h3 data-number="2.1" id="python-example">python example</h3>
<div class="sourceCode" id="cb1"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>av = buildPythonPackage <span class="kw">rec</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">name</span> <span class="op">=</span> <span class="st">&quot;av-</span><span class="sc">${</span>version<span class="sc">}</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">version</span> <span class="op">=</span> <span class="st">&quot;0.2.4&quot;</span><span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">src</span> <span class="op">=</span> pkgs.fetchurl <span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">url</span> <span class="op">=</span> <span class="st">&quot;mirror://pypi/a/av/</span><span class="sc">${</span>name<span class="sc">}</span><span class="st">.tar.gz&quot;</span><span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">sha256</span> <span class="op">=</span> <span class="st">&quot;bdc7e2e213cb9041d9c5c0497e6f8c47e84f89f1f2673a46d891cca0fb0d19a0&quot;</span><span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">buildInputs</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span>  <span class="op">(</span><span class="kw">with</span> self<span class="op">;</span> <span class="op">[</span> nose pillow numpy <span class="op">])</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">++</span> <span class="op">(</span><span class="kw">with</span> pkgs<span class="op">;</span> <span class="op">[</span> ffmpeg_2 git libav pkgconfig <span class="op">]);</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Because of https://github.com/mikeboers/PyAV/issues/152</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="va">doCheck</span> <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="va">meta</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="va">description</span> <span class="op">=</span> <span class="st">&quot;Pythonic bindings for FFmpeg/Libav&quot;</span><span class="op">;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="va">homepage</span> <span class="op">=</span> <span class="va">https</span><span class="op">://</span><span class="ss">github.com/mikeboers/PyAV</span><span class="op">/;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="va">license</span> <span class="op">=</span> licenses.bsd2<span class="op">;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>example taken from <a
href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/python-packages.nix"
class="uri">https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/python-packages.nix</a>.</p>
<h3 data-number="2.2" id="perl-example">perl example</h3>
<div class="sourceCode" id="cb2"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ack = buildPerlPackage <span class="kw">rec</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">name</span> <span class="op">=</span> <span class="st">&quot;ack-2.16&quot;</span><span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">src</span> <span class="op">=</span> fetchurl <span class="op">{</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">url</span> <span class="op">=</span> <span class="st">&quot;mirror://cpan/authors/id/P/PE/PETDANCE/</span><span class="sc">${</span>name<span class="sc">}</span><span class="st">.tar.gz&quot;</span><span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">sha256</span> <span class="op">=</span> <span class="st">&quot;0ifbmbfvagfi76i7vjpggs2hrbqqisd14f5zizan6cbdn8dl5z2g&quot;</span><span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;out&quot;</span> <span class="st">&quot;man&quot;</span><span class="op">];</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use gnused so that the preCheck command passes</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">buildInputs</span> <span class="op">=</span> stdenv.lib.optional stdenv.isDarwin gnused<span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">propagatedBuildInputs</span> <span class="op">=</span> <span class="op">[</span> FileNext <span class="op">];</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="va">meta</span> <span class="op">=</span> <span class="kw">with</span> stdenv.lib<span class="op">;</span> <span class="op">{</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">description</span> <span class="op">=</span> <span class="st">&quot;A grep-like tool tailored to working with large trees of source code&quot;</span><span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">homepage</span>    <span class="op">=</span> <span class="va">http</span><span class="op">://</span>betterthangrep.com<span class="op">/;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="va">license</span>     <span class="op">=</span> licenses.artistic2<span class="op">;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">maintainers</span> <span class="op">=</span> <span class="kw">with</span> maintainers<span class="op">;</span> <span class="op">[</span> lovek323 <span class="op">];</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">platforms</span>   <span class="op">=</span> platforms.unix<span class="op">;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tests fails on nixos and hydra because of different purity issues</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="va">doCheck</span> <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>example taken from <a
href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/perl-packages.nix"
class="uri">https://github.com/NixOS/nixpkgs/blob/master/pkgs/top-level/perl-packages.nix</a></p>
<h3 data-number="2.3" id="go-example">go example</h3>
<div class="sourceCode" id="cb3"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>terraform_0_9 = generic <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">version</span> <span class="op">=</span> <span class="st">&quot;0.9.11&quot;</span><span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">sha256</span> <span class="op">=</span> <span class="st">&quot;045zcpd4g9c52ynhgh3213p422ahds63mzhmd2iwcmj88g8i1w6x&quot;</span><span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># checks are failing again</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">doCheck</span> <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>;</span></code></pre></div>
<p>example taken from <a
href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/networking/cluster/terraform/default.nix"
class="uri">https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/networking/cluster/terraform/default.nix</a>.</p>
<h2 data-number="3" id="nixos-testing">nixos testing</h2>
<p>first, let’s have a look at how testing in nixos is done
traditionally. these tests use KVM, spawn one or serveral virtual
machines which interact with each other over the network. they are
called explicitly: <code>nix-build -A leaps release.nix</code>.</p>
<p>the leaps test:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">import</span> <span class="ss">./make-test.nix</span> <span class="op">({</span> <span class="va">pkgs</span><span class="op">,</span>  <span class="op">...</span> <span class="op">}</span>:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">name</span> <span class="op">=</span> <span class="st">&quot;leaps&quot;</span><span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">meta</span> <span class="op">=</span> <span class="kw">with</span> pkgs.stdenv.lib.maintainers<span class="op">;</span> <span class="op">{</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">maintainers</span> <span class="op">=</span> <span class="op">[</span> qknight <span class="op">];</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">nodes</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">client</span> <span class="op">=</span> <span class="op">{};</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">server</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>      <span class="va">services</span>.<span class="va">leaps</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">enable</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">port</span> <span class="op">=</span> <span class="dv">6666</span><span class="op">;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">path</span> <span class="op">=</span> <span class="st">&quot;/leaps/&quot;</span><span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>      <span class="va">networking</span>.<span class="va">firewall</span>.<span class="va">enable</span> <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="va">testScript</span> <span class="op">=</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;&#39;</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="st">      startAll;</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="st">      $server-&gt;waitForOpenPort(6666);</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="st">      $client-&gt;waitForUnit(&quot;network.target&quot;);</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="st">      $client-&gt;succeed(&quot;</span><span class="sc">${</span>pkgs.curl<span class="sc">}</span><span class="st">/bin/curl http://server:6666/leaps/ | grep -i &#39;leaps&#39;&quot;);</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="st">    &#39;&#39;</span><span class="op">;</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span></code></pre></div>
<p>nixos tests are described in the manual <a
href="https://nixos.org/nixos/manual/index.html#sec-nixos-tests"
class="uri">https://nixos.org/nixos/manual/index.html#sec-nixos-tests</a>
nicely. the source of the tests are at <a
href="https://github.com/NixOS/nixpkgs/blob/master/nixos/release.nix#L217"
class="uri">https://github.com/NixOS/nixpkgs/blob/master/nixos/release.nix#L217</a>.</p>
<h2 data-number="4" id="nixcloud-testing">nixcloud testing</h2>
<p>at nixcloud we also implement tests as we have them in nixos
(described above). some tests can be found here: <a
href="https://github.com/nixcloud/nixcloud-webservices/tree/master/tests"
class="uri">https://github.com/nixcloud/nixcloud-webservices/tree/master/tests</a>
but, and that is why this posting was written, we also have different
kind of tests, which are similar to those in perl, python and go
explained previously.</p>
<h3 data-number="4.1" id="test-usage">test usage</h3>
<p>we basically extended the nixos module system:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode nix"><code class="sourceCode nix"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">config</span><span class="op">,</span> <span class="va">pkgs</span><span class="op">,</span> <span class="va">lib</span><span class="op">,</span> <span class="op">...</span> <span class="op">}</span> @ <span class="va">args</span><span class="op">:</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">options</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixcloud</span>.<span class="va">reverse-proxy</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>      <span class="va">enable</span> <span class="op">=</span> mkEnableOption <span class="st">&quot;reverse-proxy&quot;</span><span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>      ...</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="op">;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">config</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixcloud</span>.<span class="va">tests</span>.<span class="va">wanted</span> = [ ./<span class="va">test</span>.<span class="va">nix</span> ];</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><a
href="https://github.com/nixcloud/nixcloud-webservices/blob/12e51b6bd073acdd78807d0dbb23458267538b48/modules/services/reverse-proxy/default.nix#L298">see
complete usage implementation</a></p>
<p><strong>note</strong>: the nixcloud.reverse-proxy module is similar
to nixos modules as <code>services.openssh</code></p>
<p>if the nixcloud.reverse-proxy module is used and one does a
<code>nixos-rebuild switch</code>, it evaluates the
<code>./test.nix</code> during build.</p>
<h3 data-number="4.2" id="implementation">implementation</h3>
<p>and the implementation of the test is here <a
href="https://github.com/nixcloud/nixcloud-webservices/blob/12e51b6bd073acdd78807d0dbb23458267538b48/modules/core/testing.nix"
class="uri">https://github.com/nixcloud/nixcloud-webservices/blob/12e51b6bd073acdd78807d0dbb23458267538b48/modules/core/testing.nix</a></p>
<h3 data-number="4.3" id="advances">advances</h3>
<ul>
<li><p>tests are located near the implementation of the service and not
in a completely different directory</p></li>
<li><p>a user can’t forget to run the test since they are
implicit</p></li>
<li><p>everytime a developer changes the implementation,
nixcloud.webservices for instance, it is unit tested. this insures that
users don’t forget to run the unit test before they commit.</p></li>
<li><p>these test builds are cached locally and are executed only once.
similar for packages out of nixpkgs: if a dependency or the source code
is changed, the test is also rerun.</p></li>
<li><p>oh, and hydra can evaluate the tests as well</p></li>
</ul>
<h3 data-number="4.4" id="drawbacks">drawbacks</h3>
<ul>
<li><p>a major drawback is that if you don’t have KVM support it still
spawns the tests and emulating will be very slow.</p>
<p>this is true for:</p>
<ul>
<li>remote machines which were already virtualized (and don’t support
nested virtualization)</li>
<li>if you execute nixos inside virtualbox</li>
<li>if you are using nix from inside mac os x (darwin) or basically from
any other linux other than nixos</li>
</ul></li>
</ul>
<h2 data-number="5" id="summary">summary</h2>
<p>i would love to see this feature coming to nixos/nixpkgs also! oh and
thanks to aszlig!</p>

  </div>

</div>

<div id="ArticleSourceCode">

<a href="posts/nixcloud-webservices_tests.mdwn" title="posts\nixcloud-webservices_tests.mdwn">article source</a>
</div>

</div>

<div id="scrollUp">
<span id="scrollUpBtn" class="glyphiconLink glyphicon glyphicon-chevron-up" aria-hidden="true" title="scroll up"></span>
</div>

<script>
$("#scrollUpBtn").click(function() {
  $("html, body").animate({ scrollTop: 0 }, "slow");
  return false;
});
</script>


<script>
window.onload = function(e){
  anchors.add('h1')
  anchors.add('h2')
  anchors.add('h3')
  anchors.add('h4')
  anchors.add('h5')
}
</script>




<script>
$(document).ready(function() {
  //Calls the tocify method on your HTML div.
  $("#toc").tocify();
});
$("#toc").hover(function() {
  $("#toc").css("z-index", "111")
}, function() {
  $("#toc").css("z-index", "1")
});
</script>



<script>

var shifted = false;

$(window).keyup(function(event) {
    shifted = event.shiftKey;
});

$(window).keydown(function(event) {
  if(event.keyCode == 16){
    shifted = event.shiftKey;
  }
  if (shifted == false) {
      if(event.keyCode == 37){
        $('.glyphicon-chevron-left')[0].click()
      }
      if(event.keyCode == 39){
        $('.glyphicon-chevron-right')[0].click()
      }
  }
});
</script>


<script>
// check if we got served from pankat-server
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
  if (xhr.status == 200) {
    console.log("request to /pankat-server returned status: " + xhr.status + ", so yes we got served from pankat-server");
    $('#draft').css("display", "block");
    $('#roadmap').css("display", "block");
  }
}
}
xhr.open('GET', "/pankat-server", false);
xhr.send(null);
</script>
</body>
</html>
