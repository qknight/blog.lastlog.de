<!DOCTYPE html>
<!-- this document is auto-generated from pankat document editor -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head data-article-dst-filename="system_services_on_nixos.html">

<meta charset="utf-8" />
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>system services on nixos</title>

<script src="js/jquery.min.js"></script>

<script src="js/jquery-ui-1.9.1.custom.min.js"></script>
<script src="js/jquery.tocify.min.js"></script>

<link type="text/css" rel="stylesheet" href="css/jquery.tocify.css" />



<script src="js/reconnecting-websocket.min.js"></script>
<script src="js/pankat-websocket.js"></script>
<script src="js/diffDOM.js"></script>


<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
<script src="js/bootstrap.min.js"></script>

<script src="js/anchor.min.js"></script>

<link rel="icon" href="media/favicon.ico" type="image/x-icon" />


<!--[if lt IE 9]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
<![endif]-->
<link rel="stylesheet" href="css/pandoc-kate.css" type="text/css" />
<link rel="stylesheet" href="css/style.css" type="text/css" />

</head>
<body>

<div id="toc"></div>

<!-- menu begins -->
<div class="container">
  <nav class="navbar navbar-default">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">lastlog.de/blog</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="timeline.html"><span class="glyphicon glyphicon-list" aria-hidden="true"></span> timeline</a></li>
        <li><a href="about.html"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> about</a></li>
        <li><a href="/draft" id="draft" style="display: none"><span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span> draft</a></li>
        <li><a href="/draft?article=posts/roadmap.mdwn" id="roadmap" style="display: none"><span class="glyphicon glyphicon glyphicon-road" aria-hidden="true"></span> roadmap</a></li>

      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a title="live updates of article updates on posts/system_services_on_nixos.mdwn" id="websocket" style="display: none"><span id="websocketStatus" class="glyphicon glyphicon-remove" aria-hidden="true"></span> websocket</a></li>
        <!-- <li><a href="#">Login</a></li> -->
      </ul>

      <!--<div id="right">
        <form class="navbar-form navbar-right">
          <div class="form-group">
            <input type="text" class="form-control" placeholder="Search">
          </div>
        </form>
      </div>-->
    </div><!-- /.navbar-collapse -->
  </nav>

<div id="headerAndArticle">


  <div id="headerContainer">
    <header class="header"><span id="articleNavLeft"> <a href="diploma_thesis_multi_platform_software_package_management.html"> 
      <span class="glyphiconLink glyphicon glyphicon-chevron-left" aria-hidden="true" title="previous article"> </span> prev. article
    </a> </span><span id="articleNavRight"><a href="kdevelop_on_nixos.html"> 
        next article <span class="glyphiconLink glyphicon glyphicon-chevron-right" aria-hidden="true" title="next article"></span>
    </a> </span></header>
  </div>
  

  <div class="article">
    <h1 id="SiteTitle">system services on nixos</h1>
    <div id="date"><p><span id="lastupdated">10 oct 2011</span></p></div><div id="tags"><p><a href="timeline.html?filter=tag::linux" class="tagbtn btn btn-primary">linux</a><a href="timeline.html?filter=tag::packagemanager" class="tagbtn btn btn-primary">packagemanager</a><a href="timeline.html?filter=tag::security" class="tagbtn btn btn-primary">security</a><a href="timeline.html?filter=tag::technology" class="tagbtn btn btn-primary">technology</a><a href="timeline.html?filter=tag::usability" class="tagbtn btn btn-primary">usability</a></p></div>
    <p><a href="media/nixos-lores.png"><img src=media/nixos-lores.png alt="" style="float: right"></a>
#how to integrate a daemon into nixos</p>
<p>in this short article i want to show how services can be added/used
in nixos. i personally find the nixos way a quite easy and ‘clean’
approach!</p>
<p>as i integrated cntlm my goals were:</p>
<ul>
<li><strong>easy to use</strong></li>
<li><strong>password</strong> must be stored in a <strong>safe
place</strong></li>
<li><strong>service should not be run as root</strong> but as a special
user: <strong>cntlm</strong></li>
</ul>
<p>it helped a lot to look at similar scripts like the sshd integration
but i also used “NixOS: A Purely functional Linux Distribution” [1]
which is describing most aspects which are needed to get a service up
and running.</p>
<p>seen as a developer one has to write two nix expressions:</p>
<ul>
<li><strong>cntlm/default.nix</strong> the script which describes the
software cntlm</li>
<li><strong>nixos/modules/services/networking/cntlm.nix</strong> the
script which descirbes the service</li>
</ul>
<p>seen as a user one has to modify only one nix expression:</p>
<ul>
<li><strong>/etc/nixos/configuration.nix</strong> the place where all
the configuration happens</li>
</ul>
<h2 data-number="1"
id="etcnixosnixpkgspkgstoolsnetworkingcntlmdefault.nix">/etc/nixos/nixpkgs/pkgs/tools/networking/cntlm/default.nix</h2>
<p>this nix expression describes the cntlm software and is quite simple
as it basically fetches the software/compiles it/installs it into the
system. however, a user does not have to install this software
using:</p>
<pre><code># nix-env -i cntlm</code></pre>
<p>still this would be possible, and a normal user/root user could use
the software in his profile this way.</p>
<p>anyway here is the script:</p>
<pre><code>     1  { stdenv, fetchurl, which}:
     2
     3  stdenv.mkDerivation {
     4    name = &quot;cntlm-0.35.1&quot;;
     5
     6    src = fetchurl {
     7      url = mirror://sourceforge/cntlm/cntlm-0.35.1.tar.gz;
     8      sha256 = &quot;7b3fb7184e72cc3f1743bb8e503a5305e96458bc630a7e1ebfc9f3c07ffa6c5e&quot;;
     9    };
    10
    11    buildInputs = [ which ];
    12
    13    installPhase = &#39;&#39;
    14      ensureDir $out/bin; cp cntlm $out/bin/;
    15      ensureDir $out/share/; cp COPYRIGHT README VERSION doc/cntlm.conf $out/share/;
    16      ensureDir $out/man/; cp doc/cntlm.1 $out/man/;
    17    &#39;&#39;;
    18
    19    meta = {
    20      description = &quot;Cntlm is an NTLM/NTLMv2 authenticating HTTP proxy&quot;;
    21      homepage = http://cntlm.sourceforge.net/;
    22      license = stdenv.lib.licenses.gpl2;
    23      maintainers = [ stdenv.lib.maintainers.qknight ];
    24    };
    25  }</code></pre>
<p>the only point of interest might be the buildInputs (line 11) which
includes which. in this build script ‘which gcc’ is used to test if gcc
is installed.</p>
<h2 data-number="2"
id="etcnixosnixosmodulesservicesnetworkingcntlm.nix">/etc/nixos/nixos/modules/services/networking/cntlm.nix</h2>
<p>this expression is used to <strong>integrate cntlm as a system
service.</strong></p>
<pre><code>     1  { config, pkgs, ... }:
     2
     3  with pkgs.lib;
     4
     5  let
     6
     7    cfg = config.services.cntlm;
     8    uid = config.ids.uids.cntlm;
     9
    10  in
    11
    12  {
    13
    14    options = {
    15
    16      services.cntlm= {
    17
    18        enable = mkOption {
    19          default = false;
    20          description = &#39;&#39;
    21            Whether to enable the cntlm, which start a local proxy.
    22          &#39;&#39;;
    23        };
    24
    25        username = mkOption {
    26          description = &#39;&#39;
    27            Proxy account name, without the possibility to include domain name (&#39;at&#39; sign is interpreted literally).
    28          &#39;&#39;;
    29        };
    30
    31        domain = mkOption {
    32          description = &#39;&#39;Proxy account domain/workgroup name.&#39;&#39;;
    33        };
    34
    35        password = mkOption {
    36          default = &quot;/etc/cntlm.password&quot;;
    37          type = with pkgs.lib.types; string;
    38          description = &#39;&#39;Proxy account password. Note: use chmod 0600 on /etc/cntlm.password for security.&#39;&#39;;
    39        };
    40
    41        netbios_hostname = mkOption {
    42          default = config.networking.hostName;
    43          description = &#39;&#39;
    44            The hostname of your workstation.
    45          &#39;&#39;;
    46        };
    47
    48        proxy = mkOption {
    49          description = &#39;&#39;
    50            A list of NTLM/NTLMv2 authenticating HTTP proxies.
    51
    52            Parent proxy, which requires authentication. The same as proxy on the command-line, can be used more than  once  to  specify  unlimited
    53            number  of  proxies.  Should  one proxy fail, cntlm automatically moves on to the next one. The connect request fails only if the whole
    54            list of proxies is scanned and (for each request) and found to be invalid. Command-line takes precedence over the configuration file.
    55          &#39;&#39;;
    56        };
    57
    58        port = mkOption {
    59          default = [3128];
    60          description = &quot;Specifies on which ports the cntlm daemon listens.&quot;;
    61        };
    62
    63       extraConfig = mkOption {
    64          default = &quot;&quot;;
    65          description = &quot;Verbatim contents of cntlm.conf.&quot;;
    66       };
    67
    68      };
    69
    70    };
    71
    72
    73    ###### implementation
    74
    75    config = mkIf config.services.cntlm.enable {
    76      users.extraUsers = singleton {
    77          name = &quot;cntlm&quot;;
    78          description = &quot;cntlm system-wide daemon&quot;;
    79          home = &quot;/var/empty&quot;;
    80      };
    81
    82      jobs.cntlm = {
    83          description = &quot;cntlm is an NTLM / NTLM Session Response / NTLMv2 authenticating HTTP proxy.&quot;;
    84          startOn = &quot;started network-interfaces&quot;;
    85          environment = {
    86          };
    87
    88      preStart = &#39;&#39; &#39;&#39;;
    89
    90      daemonType = &quot;fork&quot;;
    91
    92      exec =
    93        &#39;&#39;
    94          ${pkgs.cntlm}/bin/cntlm -U cntlm \
    95          -c ${pkgs.writeText &quot;cntlm_config&quot; cfg.extraConfig}
    96        &#39;&#39;;
    97      };
    98
    99      services.cntlm.extraConfig =
   100        &#39;&#39;
   101          # Cntlm Authentication Proxy Configuration
   102          Username        ${cfg.username}
   103          Domain          ${cfg.domain}
   104          Password        ${cfg.password}
   105          Workstation     ${cfg.netbios_hostname}
   106          ${concatMapStrings (entry: &quot;Proxy ${entry}\n&quot;) cfg.proxy}
   107
   108          ${concatMapStrings (port: &#39;&#39;
   109            Listen ${toString port}
   110          &#39;&#39;) cfg.port}
   111        &#39;&#39;;
   112    };
   113  }</code></pre>
<p>notable parts are:</p>
<ul>
<li>(line 1-13) <strong>if interested in general nix language: read [1]
page 6,7</strong> (and 5 might also be interesting)</li>
<li>(line 18-66) where a** list of options is declared** (some with
default arguments; some without default argument which will enforce the
user to set them)</li>
<li>(line 76-79) where the <strong>service is started as a different
user</strong> (security measure)</li>
<li>(line 92-97) where the <strong>configuration is generated on the
fly</strong> (yes <strong>cntlm.conf is generated everytime the
configuration in /etc/nixos/configuration.nix is changed</strong>). a
user using the cntlm service on nixos does not change the cntlm.conf
manually)</li>
<li>(line 99-111) where a <strong>minimal configuration</strong>
(extract of the example cntlm.conf) <strong>is
parameterized</strong>.</li>
<li>(line 106) where a <strong>list of items is transformed into a multi
line structure</strong> where:</li>
</ul>
<p><strong>cfg.proxy = [ “foo” “bar” “baz” ];</strong></p>
<p>is transformed into:</p>
<ul>
<li><strong>Proxy foo</strong></li>
<li><strong>Proxy bar</strong></li>
<li><strong>Proxy baz</strong></li>
</ul>
<h2 data-number="3" id="how-to-make-use-of-the-above-expressions">how to
make use of the above expressions</h2>
<p><strong>a user has to append this configuration into
/etc/nixos/configuration.nix</strong> and cntlm will be
installed/configured and started</p>
<pre><code>  services.cntlm = {
    enable=true;
    username=&quot;myusername&quot;;
    domain=&quot;mydomain&quot;;
    proxy=[ &quot;192.168.3.5:1234&quot; ];
  };</code></pre>
<h2 data-number="4" id="summary">summary</h2>
<p>in <strong>contrast to most other distributions nixos makes not only
packaging subject to a ‘clean’ package management but also configuration
management (/etc stuff) and runtime management</strong>. this is a very
clean design helping to avoid lots of pitfalls.</p>
<h2 data-number="5" id="links">links</h2>
<ul>
<li>[1] <a
href="http://www.st.ewi.tudelft.nl/~dolstra/pubs/nixos-jfp-final.pdf"
class="uri">http://www.st.ewi.tudelft.nl/~dolstra/pubs/nixos-jfp-final.pdf</a></li>
</ul>

  </div>

</div>

<div id="ArticleSourceCode">

<a href="posts/system_services_on_nixos.mdwn" title="posts\system_services_on_nixos.mdwn">article source</a>
</div>

</div>

<div id="scrollUp">
<span id="scrollUpBtn" class="glyphiconLink glyphicon glyphicon-chevron-up" aria-hidden="true" title="scroll up"></span>
</div>

<script>
$("#scrollUpBtn").click(function() {
  $("html, body").animate({ scrollTop: 0 }, "slow");
  return false;
});
</script>


<script>
window.onload = function(e){
  anchors.add('h1')
  anchors.add('h2')
  anchors.add('h3')
  anchors.add('h4')
  anchors.add('h5')
}
</script>




<script>
$(document).ready(function() {
  //Calls the tocify method on your HTML div.
  $("#toc").tocify();
});
$("#toc").hover(function() {
  $("#toc").css("z-index", "111")
}, function() {
  $("#toc").css("z-index", "1")
});
</script>



<script>

var shifted = false;

$(window).keyup(function(event) {
    shifted = event.shiftKey;
});

$(window).keydown(function(event) {
  if(event.keyCode == 16){
    shifted = event.shiftKey;
  }
  if (shifted == false) {
      if(event.keyCode == 37){
        $('.glyphicon-chevron-left')[0].click()
      }
      if(event.keyCode == 39){
        $('.glyphicon-chevron-right')[0].click()
      }
  }
});
</script>


<script>
// check if we got served from pankat-server
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
  if (xhr.status == 200) {
    console.log("request to /pankat-server returned status: " + xhr.status + ", so yes we got served from pankat-server");
    $('#draft').css("display", "block");
    $('#roadmap').css("display", "block");
  }
}
}
xhr.open('GET', "/pankat-server", false);
xhr.send(null);
</script>
</body>
</html>
