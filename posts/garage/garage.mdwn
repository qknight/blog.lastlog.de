
[[!meta date="2025-04-24 20:53"]]
[[!tag nix nixos libnix]]
[[!draft]]
[[!series libnix]]
[[!summary libnix integration into cargo and a discussion of crates wrapping legacy]]

[[!img media/nlnet-logo.gif class="noFancy" style="float: right"]]
[[!img posts/libnix/Nix_snowflake_windows.svg class="noFancy" style="float: right" width="200px"]]

# nixcloud umzug

- upload to github: /var/lib/gitolite
    
    drwxr-x---  7 127 127 4096 Feb 13  2020 check_hydra.git
    
    drwxr-x---  7 127 127 4096 Feb 13  2020 go-mollie.git
    drwxr-x---  7 127 127 4096 Sep 26  2017 hydra.nixcloud.io.git
    drwxr-x---  7 127 127 4096 Feb 13  2020 mkEmail.git

    drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud-backend.git
    drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud-backup.git
    drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud-container.git
    drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud-deployment.git

    drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud-editor.git
    drwxr-x---  7 127 127 4096 Mar 27  2017 nixcloud-ember.git
    drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud-frontend.git
    drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud.git

    drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud-rehash.git
    drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud-relais.git
    drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud.space.webservice.git
    drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud.stalker-backend.git
    drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud.stalker-frontend.git
    drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud.stalker.git
    drwxr-x---  7 127 127 4096 May  7  2017 nixcloud-webservices-abstraction.git
    drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud-webservices.git

drwxr-x---  7 127 127 4096 Feb 13  2020 auth.nixcloud.io.webservice.git
drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud.auth-lib.git
drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud.auth-server.git
drwxr-x---  7 127 127 4096 Nov 26  2017 nixcloud-auth-webapp.git
drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud.auth-webapp.git

drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud.dns.git
drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud.dns-server.git

drwxr-x---  7 127 127 4096 Feb 13  2020 status.nixcloud.io.webservice.git
drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud.monitoring-frontend.git
drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud.monitoring.git
drwxr-x---  7 127 127 4096 Feb 13  2020 nixcloud.monitoring-server.git
drwxr-x---  7 127 127 4096 Feb 13  2020 nixos-monitoring.git

  
# motivation

* Arduino Opta RS485
  * EUR 166
  * https://docs.arduino.cc/resources/datasheets/AFX00001-AFX00002-AFX00003-datasheet.pdf
  * https://docs.arduino.cc/tutorials/opta/getting-started-with-modbus-rtu/
  * https://docs.arduino.cc/tutorials/opta/getting-started-with-interrupts/
  * https://docs.arduino.cc/tutorials/opta/getting-started-with-rs485/
  * https://rehfuss.com/wp-content/uploads/2021/05/Operating_instructions_Optidrive_E3-IP66_en.pdf#45

* inverter: ODE-3-120023-1f12 INVERTEK DRIVES-Vektor-Umrichter
  * EUR 188
  * https://www.tme.eu/de/details/ode-3-120023-1012/einphaseninverter/invertek-drives/?brutto=1&currency=EUR&gad_campaignid=10626674532

* inverter: automation direct GS21-20P2
  * EUR 280
  * https://www.youtube.com/watch?v=Jc_zCsXKAV0 (first steps)
  * https://www.youtube.com/watch?v=YnbSvT0u2_o
  * https://cdn.automationdirect.com/static/manuals/gs20m/appxe.pdf (safe torque function)
  * https://cdn.automationdirect.com/static/specs/gs20drives.pdf (overview)
  * https://cdn.automationdirect.com/static/manuals/gs20m/gs20m.pdf

* chatgpt
  * https://chatgpt.com/share/68ce97df-5404-800c-9b84-12f2dabe5b98

* KTC-50m
  * https://www.waycon.de/fileadmin/linearpotentiometer/Linearpotentiometer-LRW.pdf (anleitung)
  * https://miranyuki.en.made-in-china.com/product/fjpxzUwyAFhH/China-Miran-Ktc-50mm-Linear-Position-Sensor-for-Injection-Molding-Machine.html
* schloss
  * 13 euro
  * https://de.aliexpress.com/item/1005005932336596.html?spm=a2g0o.productlist.main.7.3f162890kA3JFu&algo_pvid=6a7153e1-a17a-455c-8d53-dc6532de8154&pdp_ext_f=%7B%22order%22%3A%2251%22%2C%22eval%22%3A%221%22%2C%22fromPage%22%3A%22search%22%7D&utparam-url=scene%3Asearch%7Cquery_from%3A%7Cx_object_id%3A1005005932336596%7C_p_origin_prod%3A

* relais
  * Finder 385.170.240.050 385170240050 Koppelrelais 6,2 mm, Blau
    * https://www.amazon.de/FINDER-385-170-240-050-385170240050-Koppelrelais-n/dp/B01185UBDG/ref=sr_1_5?__mk_de_DE=%C3%85M%C3%85%C5%BD%C3%95%C3%91&sr=8-5




# motor

Hersteller: OBERMOSER
Typ: D74 K17/1 → interne Typbezeichnung
Spannung: 220/380 V Δ/Y
  Δ = Dreieckschaltung bei 220 V
  Y = Sternschaltung bei 380 V
  
Stromaufnahme: 1,3 / 0,75 A
  bei 220 V = 1,3 A
  bei 380 V = 0,75 A
  
Leistung: 0,18 kW → Motorleistung (ca. 180 Watt)
Frequenz: 50 Hz → Netzfrequenz
Drehzahl: 1360 U/min → Nenndrehzahl bei Nennlast (passt zu einem 4-poligen Motor mit Schlupf)
Betriebsart: S1 oder ähnlich (nicht klar lesbar, evtl. Dauerbetrieb)
cos φ: 0,65 → Leistungsfaktor (Verhältnis Wirkleistung zu Scheinleistung)
Schutzart: IP44 → Schutz gegen feste Fremdkörper >1 mm und gegen Spritzwasser
Bauform: B5 → Motor mit Flanschbefestigung
Isolationsklasse: B → max. Wicklungstemperatur 130 °C

# Arduino Opta

https://docs.arduino.cc/resources/datasheets/AFX00001-AFX00002-AFX00003-datasheet.pdf


## inputs

Number of inputs 8x Analog/Digital inputs
Inputs overvoltage protection Yes
Antipolarity protection Yes
Input impedance 8.9 kΩ

### Analog Inputs
Characteristics Details
Analog Input voltage 0...10 V
Analog Input resolution 12...16 bits - User configurable
Analog Input LSB value 166 µV
Accuracy +/- 5%, repeatability +/- 2%

### Digital Inputs
Characteristics Details
Digital Input voltage 0...24 V
Digital Input voltage logic level Voltage Input Low (VIL) Maximum: 4.46 VDC. Voltage Input High (VIH)
Minimum: 6.6 VDC
Digital Input current 1.12 mA at 10 V
Digital Input frequency 4.5 kHz
Cycle time for analog input
acquisition 10 µs


# door

14 s open
14 s close

## zahnrad & kette

kettenlaenge: 2000mm
zahnrad drumesser: 70mm
zahnrad umfang: 220mm

2000/220 = 9 umdrehungen

14s/9u = 0.64 u/s => 

# gehäuse

- https://www.rittal.com/de-de/products/PG20231215SCH101/PG20231215SCH201 markus findet die gut
- https://de.rs-online.com/web/ (guter shop)
- https://www.voelkner.de/

# architecture

## inputs

- emergency power cut
- buttons
 - open button
 - close button
 - stop button
 - toggle button

- 0..10v absolute door position (from reference platform)
- door lock and actuator

## outputs

- motor control modbus
- lamp
 - about to open (orange)
 - running (green)
 - error (red)
- door lock/unlock

## control loop

- monitor torque, if exeeded, stop motor -> error
- monitor duration, if exeeded, stop motor -> error
- if modbus disconnected (), stop motor -> error
- if opening/closing process exceeds time intervall -> error
- end position switches indicate near end, so go slow unitl soft torque excess
- accept up/down command while in CLOSED | OPEN only
- manual door open prevention: if door is moved without command, detected by end position switch not on close anymore, close it again

### modbus keep-alive

on the optidrive e3 it is P-36 index 3 with 3000ms default, which should be set to 500ms instead. once the finder OPTA stops sending queries (which act as keep-alive) the drive stops

# references

## rust code on arduino 

https://github.com/stm32-rs/stm32h7xx-hal/blob/master/examples/blinky.rs

## tutorial

https://opta.findernet.com/en/tutorial/getting-started