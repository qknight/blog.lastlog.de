<!DOCTYPE html>
<!-- this document is auto-generated from pankat document editor -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head data-article-dst-filename="playing_FTL_on_NIXOS.html">

<meta charset="utf-8" />
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>playing FTL on NIXOS</title>

<script src="js/jquery.min.js"></script>

<script src="js/jquery-ui-1.9.1.custom.min.js"></script>
<script src="js/jquery.tocify.min.js"></script>

<link type="text/css" rel="stylesheet" href="css/jquery.tocify.css" />



<script src="js/reconnecting-websocket.min.js"></script>
<script src="js/pankat-websocket.js"></script>
<script src="js/diffDOM.js"></script>


<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
<script src="js/bootstrap.min.js"></script>

<script src="js/anchor.min.js"></script>

<link rel="icon" href="media/favicon.ico" type="image/x-icon" />


<!--[if lt IE 9]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
<![endif]-->
<link rel="stylesheet" href="css/pandoc-kate.css" type="text/css" />
<link rel="stylesheet" href="css/style.css" type="text/css" />

</head>
<body>

<div id="toc"></div>

<!-- menu begins -->
<div class="container">
  <nav class="navbar navbar-default">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">lastlog.de/blog</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="timeline.html"><span class="glyphicon glyphicon-list" aria-hidden="true"></span> timeline</a></li>
        <li><a href="about.html"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> about</a></li>
        <li><a href="/draft" id="draft" style="display: none"><span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span> draft</a></li>
        <li><a href="/draft?article=posts/roadmap.mdwn" id="roadmap" style="display: none"><span class="glyphicon glyphicon glyphicon-road" aria-hidden="true"></span> roadmap</a></li>

      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a title="live updates of article updates on posts/playing_FTL_on_NIXOS.mdwn" id="websocket" style="display: none"><span id="websocketStatus" class="glyphicon glyphicon-remove" aria-hidden="true"></span> websocket</a></li>
        <!-- <li><a href="#">Login</a></li> -->
      </ul>

      <!--<div id="right">
        <form class="navbar-form navbar-right">
          <div class="form-group">
            <input type="text" class="form-control" placeholder="Search">
          </div>
        </form>
      </div>-->
    </div><!-- /.navbar-collapse -->
  </nav>

<div id="headerAndArticle">


  <div id="headerContainer">
    <header class="header"><span id="articleNavLeft"> <a href="attic-backup.html"> 
      <span class="glyphiconLink glyphicon glyphicon-chevron-left" aria-hidden="true" title="previous article"> </span> prev. article
    </a> </span><span id="articleNavRight"><a href="useflags_in_nixos.html"> 
        next article <span class="glyphiconLink glyphicon glyphicon-chevron-right" aria-hidden="true" title="next article"></span>
    </a> </span></header>
  </div>
  

  <div class="article">
    <h1 id="SiteTitle">playing FTL on NIXOS</h1>
    <div id="date"><p><span id="lastupdated">13 apr 2015</span></p></div><div id="tags"><p><a href="timeline.html?filter=tag::nixos" class="tagbtn btn btn-primary">nixos</a><a href="timeline.html?filter=tag::FTL" class="tagbtn btn btn-primary">FTL</a><a href="timeline.html?filter=tag::patchelf" class="tagbtn btn btn-primary">patchelf</a><a href="timeline.html?filter=tag::linux" class="tagbtn btn btn-primary">linux</a><a href="timeline.html?filter=tag::usability" class="tagbtn btn btn-primary">usability</a></p></div>
    <p><a href="media/nixos-lores.png"><img src=media/nixos-lores.png alt="" style="float: right" caption="" class="noFancy"></a></p>
<h2 data-number="1" id="motivation">motivation</h2>
<p>this posting is about how to <strong>get a binary only x86/amd64 game
called FTL [1] on nixos</strong>. the problem to solve is how to tell
the game the proper library locations in the /nix/store!</p>
<p><a href="media/ftl.jpg"><img src=media/ftl.jpg alt="" caption=""></a></p>
<h2 data-number="2" id="how-to-make-it-work">how to make it work</h2>
<p>in order to get the FTL binary to work, you can do either of these
possibilities:</p>
<ul>
<li>use patchelf without any use of a .nix expression (ad-hoc solution,
very hacky)</li>
<li>use LD_LIBRARY_PATH (ad-hoc solution, very hacky)</li>
<li>use patchelf from a .nix expression (recommended solution)</li>
</ul>
<p>with this posting i want to document all three solutions for FTL.</p>
<h3 data-number="2.1" id="fixing-binaries">fixing binaries</h3>
<p>i’ve been using FTL FTL.1.5.13.tar.gz and i extract it like this:</p>
<pre><code>$ tar xzf FTL.1.5.13.tar.gz</code></pre>
<p>the archive contains:</p>
<pre><code>$ du -a FTL
216         FTL/data/amd64/lib/libILU.so.1
1280        FTL/data/amd64/lib/libIL.so.1
224         FTL/data/amd64/lib/libbass.so
2200        FTL/data/amd64/lib/libfreetype.so.6
100         FTL/data/amd64/lib/libz.so.1
40          FTL/data/amd64/lib/libbassmix.so
528         FTL/data/amd64/lib/libpng12.so.0
56          FTL/data/amd64/lib/libILUT.so.1
2104        FTL/data/amd64/lib/libSDL-1.2.so.0
6752        FTL/data/amd64/lib
216         FTL/data/amd64/bin/libILU.so.1
1280        FTL/data/amd64/bin/libIL.so.1
224         FTL/data/amd64/bin/libbass.so
2200        FTL/data/amd64/bin/libfreetype.so.6
100         FTL/data/amd64/bin/libz.so.1
40          FTL/data/amd64/bin/libbassmix.so
528         FTL/data/amd64/bin/libpng12.so.0
56          FTL/data/amd64/bin/libILUT.so.1
2104        FTL/data/amd64/bin/libSDL-1.2.so.0
3500        FTL/data/amd64/bin/FTL
10252       FTL/data/amd64/bin
17008       FTL/data/amd64
196548      FTL/data/resources/resource.dat
1480        FTL/data/resources/data.dat
4           FTL/data/resources/exe_icon.bmp
198036      FTL/data/resources
180         FTL/data/x86/lib/libILU.so.1
1032        FTL/data/x86/lib/libIL.so.1
212         FTL/data/x86/lib/libbass.so
1792        FTL/data/x86/lib/libfreetype.so.6
96          FTL/data/x86/lib/libz.so.1
36          FTL/data/x86/lib/libbassmix.so
456         FTL/data/x86/lib/libpng12.so.0
48          FTL/data/x86/lib/libILUT.so.1
1856        FTL/data/x86/lib/libSDL-1.2.so.0
5712        FTL/data/x86/lib
3396        FTL/data/x86/bin/FTL
3400        FTL/data/x86/bin
9116        FTL/data/x86
28          FTL/data/licenses/LGPL.txt
4           FTL/data/licenses/README-RapidXML.txt
4           FTL/data/licenses/README-zlib.txt
4           FTL/data/licenses/README-SDL.txt
8           FTL/data/licenses/README-FreeType.txt
4           FTL/data/licenses/README-DevIL.txt
56          FTL/data/licenses
20          FTL/data/exe_icon.bmp
4           FTL/data/FTL
224244      FTL/data
12          FTL/FTL_README.html
4           FTL/FTL
224264      FTL</code></pre>
<p>FTL/FTL is a bash script, we skip it and check the
FTL/data/amd64/bin/FTL binary:</p>
<pre><code>$ file FTL/data/amd64/bin/FTL
FTL: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.8, stripped</code></pre>
<p>which looks good, now let’s execute it:</p>
<pre><code>$ FTL/data/amd64/bin/./FTL
zsh: no such file or directory: ./FTL</code></pre>
<p>note: this error message is not very helpful!</p>
<p>let’s have a look at the FTL/data/amd64/bin/FTL ELF part (interpreter
and RPATH):</p>
<pre><code>$ patchelf --print-interpreter FTL/data/amd64/bin/FTL
/lib64/ld-linux-x86-64.so.2

$ patchelf --print-rpath FTL/data/amd64/bin/FTL
(empty output)</code></pre>
<p>‘/lib64/ld-linux-x86-64.so.2’ won’t be running on nixos, so let’s
find a proper interpreter:</p>
<pre><code>$ du -a /nix/store | grep ld-linux-x86-64.so.2
0       /nix/store/93zfs0zzndi7pkjkjxawlafdj8m90kg5-glibc-2.20/lib/ld-linux-x86-64.so.2
0       /nix/store/94n64qy99ja0vgbkf675nyk39g9b978n-glibc-2.19/lib/ld-linux-x86-64.so.2
0       /nix/store/i11d0d4015p0vbdnjq7lb509v9pwp049-glibc-2.19/lib/ld-linux-x86-64.so.2
0       /nix/store/cj7a81wsm1ijwwpkks3725661h3263p5-glibc-2.13/lib/ld-linux-x86-64.so.2
4       /nix/store/kp4m5d52ljhb2fyxvnm6jgkbaf3hkdkv-glibc-multi-2.20/lib/ld-linux-x86-64.so.2
0       /nix/store/la5imi1602jxhpds9675n2n2d0683lbq-glibc-2.20/lib/ld-linux-x86-64.so.2
144     /nix/store/gakif09g14jybn6vkgnzb0kn46kqg1w6-extra-utils/lib/ld-linux-x86-64.so.2
4       /nix/store/g9y2f5awcw9jdgirlv7163k3g5hjak0a-system-path/lib/ld-linux-x86-64.so.2
0       /nix/store/nrxyygy0wqski1klq0305d3h523k41ps-glibc-2.20/lib/ld-linux-x86-64.so.2
0       /nix/store/zm4bhsm8lprkzvrjgqr0klfkvr21als4-glibc-2.17/lib/ld-linux-x86-64.so.2
0       /nix/store/c8lg3m5mr246fvlx6xsrxa0sykv4l9pg-bootstrap-tools/lib/ld-linux-x86-64.so.2
0       /nix/store/ywxpkmy9kagcsvbjjhi46pr4xwpd6sfm-glibc-2.19/lib/ld-linux-x86-64.so.2
0       /nix/store/r2nzgy23qzfn273n9mbqngyidm05670f-glibc-2.19/lib/ld-linux-x86-64.so.2
4       /nix/store/i4bqvffrh47rlbc42dkqhzgmrw40zfvy-system-path/lib/ld-linux-x86-64.so.2
4       /nix/store/qdd4ypr32j1d373779ggnqqmgqm29xyb-system-path/lib/ld-linux-x86-64.so.2
4       /nix/store/vi4r0vw7jipwzfxhrqghzny74jsgxv5c-system-path/lib/ld-linux-x86-64.so.2
0       /nix/store/pdskwizjw8ar31hql2wjnnx6g0s6xc50-glibc-2.19/lib/ld-linux-x86-64.so.2
0       /nix/store/7yvf54nxwmaslcgyqfghqsqr1dwmr8ld-glibc-2.20/lib/ld-linux-x86-64.so.2
4       /nix/store/ggz4x9azga18bs2n2n5ap9qq1m088694-system-path/lib/ld-linux-x86-64.so.2
0       /nix/store/k0vqprjmxybr7clvfljk13zsdjwklcch-bootstrap-tools/lib/ld-linux-x86-64.so.2
0       /nix/store/q784x64hp3nwdxx7lbgb16f74i2bhxxk-glibc-2.18/lib/ld-linux-x86-64.so.2
0       /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/ld-linux-x86-64.so.2
144     /nix/store/nvxln8cf8aprddpvz5zpx8xgn34w9mz3-extra-utils/lib/ld-linux-x86-64.so.2
4       /nix/store/5rr3d51im48n5y3sx0kr9l61z0b9i5bs-system-path/lib/ld-linux-x86-64.so.2
0       /nix/store/6k9z1sfl7kghmagwd205k3i81pbcw57s-glibc-2.21/lib/ld-linux-x86-64.so.2</code></pre>
<p>now just pick a ‘random’ one and issue:</p>
<pre><code>$ patchelf --set-interpreter /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/ld-linux-x86-64.so.2 FTL/data/amd64/bin/FTL</code></pre>
<p>and run it again:</p>
<pre><code>$ FTL/data/amd64/bin/FTL
./FTL: error while loading shared libraries: libGL.so.1: cannot open shared object file: No such file or directory</code></pre>
<p>looks much better now, let’s see the library (DSOs - dynamic shared
objects) status:</p>
<pre><code>$ ldd FTL/data/amd64/bin/FTL
    linux-vdso.so.1 (0x00007fff495e2000)
    libSDL-1.2.so.0 =&gt; ../lib/libSDL-1.2.so.0 (0x00007f7d2cdc5000)
    libGL.so.1 =&gt; not found
    libfreetype.so.6 =&gt; ../lib/libfreetype.so.6 (0x00007f7d2cb42000)
    libIL.so.1 =&gt; ../lib/libIL.so.1 (0x00007f7d2c827000)
    libILU.so.1 =&gt; ../lib/libILU.so.1 (0x00007f7d2c612000)
    libILUT.so.1 =&gt; ../lib/libILUT.so.1 (0x00007f7d2c40c000)
    libbass.so =&gt; ../lib/libbass.so (0x00007f7d2d127000)
    libbassmix.so =&gt; ../lib/libbassmix.so (0x00007f7d2c303000)
    librt.so.1 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/librt.so.1 (0x00007f7d2c0fb000)
    libstdc++.so.6 =&gt; not found
    libm.so.6 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libm.so.6 (0x00007f7d2bdf8000)
    libc.so.6 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libc.so.6 (0x00007f7d2ba49000)
    libpthread.so.0 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libpthread.so.0 (0x00007f7d2b82b000)
    libdl.so.2 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libdl.so.2 (0x00007f7d2b627000)
    libpng12.so.0 =&gt; ../lib/libpng12.so.0 (0x00007f7d2b402000)
    /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/ld-linux-x86-64.so.2 (0x00007f7d2d056000)
    libstdc++.so.6 =&gt; not found
    libgcc_s.so.1 =&gt; not found
    libGLU.so.1 =&gt; not found
    libGL.so.1 =&gt; not found
    libz.so.1 =&gt; ../lib/libz.so.1 (0x00007f7d2b1ec000)</code></pre>
<p>wonderful, so all the libraries coming with FTL are already in the
RPATH of the binary (as libSDL-1.2.so.0, …), so we have to find the
missing ones:</p>
<p>TODO: patchelf for these libraries:</p>
<ul>
<li>libGL.so.1</li>
<li>libstdc++.so.6</li>
<li>libstdc++.so.6</li>
<li>libgcc_s.so.1</li>
<li>libGLU.so.1</li>
</ul>
<p>again, use this command to find candidates:</p>
<pre><code>$ du -a /nix/store | grep libGL.so.1</code></pre>
<p>note: DSOs might introduce other DSOs and thus you might have to add
even more libraries than shown here. hint: later we are about to find
out that we require libasound.so which is not listed just yet!</p>
<p>and again, pick one:</p>
<p>i picked this one:
/nix/store/0sgyyrml3j55nx4mmb3v099n7g1fidr4-mesa-10.2.9/lib/libGL.so.1</p>
<p>so the command goes like this:</p>
<pre><code>$ patchelf --set-rpath FTL/data/amd64/lib:/nix/store/0sgyyrml3j55nx4mmb3v099n7g1fidr4-mesa-10.2.9/lib/ FTL/data/amd64/bin/FTL</code></pre>
<p>note: FTL/data/amd64/lib contains the bundled libraries! you should
run ‘patchelf –set-rpath’ from the location you want to start the binary
later on. in case of FTL this would be ‘FTL/’ but in this example i was
using the parent directory of ‘FTL/’. also note that you can set the
RPATH to an absolute directory which is good until you move the FTL
program into a different location or use relative path names which is
good until you decided to run the program from any other directory as
the one you issued the ‘patchelf –set-rpath’ from. <em>sigh</em></p>
<p>and afterwards the ldd output has changed a lot:</p>
<pre><code>$ ldd FTL/data/amd64/bin/FTL
    linux-vdso.so.1 (0x00007fff04dcd000)
    libSDL-1.2.so.0 =&gt; FTL/data/amd64/lib/libSDL-1.2.so.0 (0x00007f512a1c8000)
    libGL.so.1 =&gt; /nix/store/fiz0mz982n1m03qzbpvl40n51bvr4b0m-mesa-10.4.5/lib/libGL.so.1 (0x00007f5129f3c000)
    libfreetype.so.6 =&gt; FTL/data/amd64/lib/libfreetype.so.6 (0x00007f5129cb9000)
    libIL.so.1 =&gt; FTL/data/amd64/lib/libIL.so.1 (0x00007f512999e000)
    libILU.so.1 =&gt; FTL/data/amd64/lib/libILU.so.1 (0x00007f5129788000)
    libILUT.so.1 =&gt; FTL/data/amd64/lib/libILUT.so.1 (0x00007f5129582000)
    libbass.so =&gt; FTL/data/amd64/lib/libbass.so (0x00007f512a52a000)
    libbassmix.so =&gt; FTL/data/amd64/lib/libbassmix.so (0x00007f5129479000)
    librt.so.1 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/librt.so.1 (0x00007ff8f3d18000)
    libstdc++.so.6 =&gt; /nix/store/jrhjp66sdfv0pc95dwgdz2sly9hima23-gcc-4.8.4/lib/libstdc++.so.6 (0x00007ff8f3a15000)
    libm.so.6 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libm.so.6 (0x00007ff8f3712000)
    libc.so.6 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libc.so.6 (0x00007ff8f3363000)
    libpthread.so.0 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libpthread.so.0 (0x00007ff8f3145000)
    libdl.so.2 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libdl.so.2 (0x00007ff8f2f41000)
    libexpat.so.1 =&gt; /nix/store/vydr1x0s2lpw2id04388azad7xaw4m8w-expat-2.1.0/lib/libexpat.so.1 (0x00007ff8f2d18000)
    libglapi.so.0 =&gt; /nix/store/fiz0mz982n1m03qzbpvl40n51bvr4b0m-mesa-10.4.5/lib/libglapi.so.0 (0x00007ff8f2aef000)
    libXdamage.so.1 =&gt; /nix/store/j292kvvwsfyqx73a6zyn81ykmrbkcf31-libXdamage-1.1.4/lib/libXdamage.so.1 (0x00007ff8f28ed000)
    libXfixes.so.3 =&gt; /nix/store/98gi4m67cr1cgrw6c1g2r51wyd6x8nld-libXfixes-5.0.1/lib/libXfixes.so.3 (0x00007ff8f26e8000)
    libX11-xcb.so.1 =&gt; /nix/store/vsk28b0riggcmigbgkzahf93xj3hw7gx-libX11-1.6.2/lib/libX11-xcb.so.1 (0x00007ff8f24e7000)
    libxcb-glx.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-glx.so.0 (0x00007ff8f22d1000)
    libxcb-dri2.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-dri2.so.0 (0x00007ff8f20cd000)
    libxcb-dri3.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-dri3.so.0 (0x00007ff8f1ecb000)
    libxcb-present.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-present.so.0 (0x00007ff8f1cc9000)
    libxcb-randr.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-randr.so.0 (0x00007ff8f1abd000)
    libxcb-xfixes.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-xfixes.so.0 (0x00007ff8f18b7000)
    libxcb-render.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-render.so.0 (0x00007ff8f16ae000)
    libxcb-shape.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-shape.so.0 (0x00007ff8f14ab000)
    libxcb-sync.so.1 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-sync.so.1 (0x00007ff8f12a6000)
    libxshmfence.so.1 =&gt; /nix/store/mib83k6wfp6dg7rffk2k3zrr1vhpdm90-libxshmfence-1.2/lib/libxshmfence.so.1 (0x00007ff8f10a4000)
    libXxf86vm.so.1 =&gt; /nix/store/alfnyr2zf1y2y348lrrv9r0b7lhamlz2-libXxf86vm-1.1.3/lib/libXxf86vm.so.1 (0x00007ff8f0e9f000)
    libXext.so.6 =&gt; /nix/store/iaaijiqdji1bhjgpa4rdvdw1a1z9rpn3-libXext-1.3.3/lib/libXext.so.6 (0x00007ff8f0c8d000)
    libX11.so.6 =&gt; /nix/store/vsk28b0riggcmigbgkzahf93xj3hw7gx-libX11-1.6.2/lib/libX11.so.6 (0x00007ff8f0953000)
    libxcb.so.1 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb.so.1 (0x00007ff8f0735000)
    libXau.so.6 =&gt; /nix/store/4fk2pcy9nwyhsipin43r1svh2h02hk5a-libXau-1.0.8/lib/libXau.so.6 (0x00007ff8f0532000)
    libXdmcp.so.6 =&gt; /nix/store/khd2573yk3v3d8jspf0m9ad2hma64sc0-libXdmcp-1.1.1/lib/libXdmcp.so.6 (0x00007ff8f032d000)
    libdrm.so.2 =&gt; /nix/store/zci3rhzh24s6zwfxdysb9mqwrzbn7lyb-libdrm-2.4.59/lib/libdrm.so.2 (0x00007ff8f0121000)
    libpng12.so.0 =&gt; not found
    libgcc_s.so.1 =&gt; /nix/store/jrhjp66sdfv0pc95dwgdz2sly9hima23-gcc-4.8.4/lib/libgcc_s.so.1 (0x00007ff8eff0b000)
    libpng12.so.0 =&gt; /nix/store/i7ifkqarb8m0w58vs96mqvj0giwll2km-libpng-1.2.51/lib/libpng12.so.0 (0x00007ff8efce5000)
    libGLU.so.1 =&gt; /nix/store/fiz0mz982n1m03qzbpvl40n51bvr4b0m-mesa-10.4.5/lib/libGLU.so.1 (0x00007ff8efa66000)
    /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/ld-linux-x86-64.so.2 (0x00007ff8f4f00000)
    libz.so.1 =&gt; /nix/store/mvjf7dvnpqz9zlvnq4yi86xbc5k9j94r-zlib-1.2.8/lib/libz.so.1 (0x00007ff8ef84e000)</code></pre>
<p>note: it is common that DSOs depend on other DSOs, just use ‘ldd’ to
find out.</p>
<p>patchelf –set-rpath
FTL/data/amd64/lib:/nix/store/0sgyyrml3j55nx4mmb3v099n7g1fidr4-mesa-10.2.9/lib/:/nix/store/ds3k0yci9swgglvjmn78p7fcz02ma4vr-gcc-4.8.4/lib64
FTL/data/amd64/bin/FTL</p>
<p>note: sometimes there are folders called /lib and lib64, do NOT mix
them as you only want 64bit libraries! but other times also 64bit
libraries are in a /lib folder, so happy guessing!</p>
<pre><code>$ ldd FTL/data/amd64/bin/FTL
    linux-vdso.so.1 (0x00007fff017d4000)
    libSDL-1.2.so.0 =&gt; FTL/data/amd64/lib/libSDL-1.2.so.0 (0x00007f8617b76000)
    libGL.so.1 =&gt; /nix/store/fiz0mz982n1m03qzbpvl40n51bvr4b0m-mesa-10.4.5/lib/libGL.so.1 (0x00007f86178ea000)
    libfreetype.so.6 =&gt; FTL/data/amd64/lib/libfreetype.so.6 (0x00007f8617667000)
    libIL.so.1 =&gt; FTL/data/amd64/lib/libIL.so.1 (0x00007f861734c000)
    libILU.so.1 =&gt; FTL/data/amd64/lib/libILU.so.1 (0x00007f8617137000)
    libILUT.so.1 =&gt; FTL/data/amd64/lib/libILUT.so.1 (0x00007f8616f31000)
    libbass.so =&gt; FTL/data/amd64/lib/libbass.so (0x00007f8617ed8000)
    libbassmix.so =&gt; FTL/data/amd64/lib/libbassmix.so (0x00007f8616e28000)
    librt.so.1 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/librt.so.1 (0x00007f8616c20000)
    libstdc++.so.6 =&gt; /nix/store/jrhjp66sdfv0pc95dwgdz2sly9hima23-gcc-4.8.4/lib/libstdc++.so.6 (0x00007f861691d000)
    libm.so.6 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libm.so.6 (0x00007f861661a000)
    libc.so.6 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libc.so.6 (0x00007f861626b000)
    libpthread.so.0 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libpthread.so.0 (0x00007f861604d000)
    libdl.so.2 =&gt; /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libdl.so.2 (0x00007f8615e49000)
    libexpat.so.1 =&gt; /nix/store/vydr1x0s2lpw2id04388azad7xaw4m8w-expat-2.1.0/lib/libexpat.so.1 (0x00007f8615c20000)
    libglapi.so.0 =&gt; /nix/store/fiz0mz982n1m03qzbpvl40n51bvr4b0m-mesa-10.4.5/lib/libglapi.so.0 (0x00007f86159f7000)
    libXdamage.so.1 =&gt; /nix/store/j292kvvwsfyqx73a6zyn81ykmrbkcf31-libXdamage-1.1.4/lib/libXdamage.so.1 (0x00007f86157f5000)
    libXfixes.so.3 =&gt; /nix/store/98gi4m67cr1cgrw6c1g2r51wyd6x8nld-libXfixes-5.0.1/lib/libXfixes.so.3 (0x00007f86155f0000)
    libX11-xcb.so.1 =&gt; /nix/store/vsk28b0riggcmigbgkzahf93xj3hw7gx-libX11-1.6.2/lib/libX11-xcb.so.1 (0x00007f86153ef000)
    libxcb-glx.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-glx.so.0 (0x00007f86151d9000)
    libxcb-dri2.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-dri2.so.0 (0x00007f8614fd5000)
    libxcb-dri3.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-dri3.so.0 (0x00007f8614dd3000)
    libxcb-present.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-present.so.0 (0x00007f8614bd1000)
    libxcb-randr.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-randr.so.0 (0x00007f86149c5000)
    libxcb-xfixes.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-xfixes.so.0 (0x00007f86147bf000)
    libxcb-render.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-render.so.0 (0x00007f86145b6000)
    libxcb-shape.so.0 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-shape.so.0 (0x00007f86143b3000)
    libxcb-sync.so.1 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb-sync.so.1 (0x00007f86141ae000)
    libxshmfence.so.1 =&gt; /nix/store/mib83k6wfp6dg7rffk2k3zrr1vhpdm90-libxshmfence-1.2/lib/libxshmfence.so.1 (0x00007f8613fac000)
    libXxf86vm.so.1 =&gt; /nix/store/alfnyr2zf1y2y348lrrv9r0b7lhamlz2-libXxf86vm-1.1.3/lib/libXxf86vm.so.1 (0x00007f8613da7000)
    libXext.so.6 =&gt; /nix/store/iaaijiqdji1bhjgpa4rdvdw1a1z9rpn3-libXext-1.3.3/lib/libXext.so.6 (0x00007f8613b95000)
    libX11.so.6 =&gt; /nix/store/vsk28b0riggcmigbgkzahf93xj3hw7gx-libX11-1.6.2/lib/libX11.so.6 (0x00007f861385b000)
    libxcb.so.1 =&gt; /nix/store/16g3p2596fjvkiwlzxgs6qrc0fmj0dnk-libxcb-1.11/lib/libxcb.so.1 (0x00007f861363d000)
    libXau.so.6 =&gt; /nix/store/4fk2pcy9nwyhsipin43r1svh2h02hk5a-libXau-1.0.8/lib/libXau.so.6 (0x00007f861343a000)
    libXdmcp.so.6 =&gt; /nix/store/khd2573yk3v3d8jspf0m9ad2hma64sc0-libXdmcp-1.1.1/lib/libXdmcp.so.6 (0x00007f8613235000)
    libdrm.so.2 =&gt; /nix/store/zci3rhzh24s6zwfxdysb9mqwrzbn7lyb-libdrm-2.4.59/lib/libdrm.so.2 (0x00007f8613029000)
    libpng12.so.0 =&gt; not found
    libgcc_s.so.1 =&gt; /nix/store/jrhjp66sdfv0pc95dwgdz2sly9hima23-gcc-4.8.4/lib/libgcc_s.so.1 (0x00007f8612e13000)
    libpng12.so.0 =&gt; not found
    libGLU.so.1 =&gt; /nix/store/fiz0mz982n1m03qzbpvl40n51bvr4b0m-mesa-10.4.5/lib/libGLU.so.1 (0x00007f8612b94000)
    /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/ld-linux-x86-64.so.2 (0x00007f8617e07000)</code></pre>
<p>now repeat the same procedure time and again to get all the DSOs
found.</p>
<p>note: sometimes this does not work as you simply don’t have the
required libraries installed in the store! then either install them
directly or any software which might use them (indirectly). however,
when using libraries like this one will have a problem if the libraries
are GCed (garbage collected) but the GC does not know that the libraries
are still in use (in this case through FTL, by our patchelf hack).</p>
<p>interestinly, using patchelf on the FTL binary with the store paths
to libpng12.so.0 seems to have no effect, the outcome is always:</p>
<pre><code>$  ldd FTL/data/amd64/lib/libIL.so.1
    linux-vdso.so.1 (0x00007fff3cbcf000)
    libpng12.so.0 =&gt; not found
    libstdc++.so.6 =&gt; /nix/store/jrhjp66sdfv0pc95dwgdz2sly9hima23-gcc-4.8.4/lib/libstdc++.so.6 (0x00007f7e2d949000)
    libm.so.6 =&gt; /nix/store/93zfs0zzndi7pkjkjxawlafdj8m90kg5-glibc-2.20/lib/libm.so.6 (0x00007f7e2d646000)
    libc.so.6 =&gt; /nix/store/93zfs0zzndi7pkjkjxawlafdj8m90kg5-glibc-2.20/lib/libc.so.6 (0x00007f7e2d2a9000)
    libgcc_s.so.1 =&gt; /nix/store/jrhjp66sdfv0pc95dwgdz2sly9hima23-gcc-4.8.4/lib/libgcc_s.so.1 (0x00007f7e2d092000)
    /nix/store/93zfs0zzndi7pkjkjxawlafdj8m90kg5-glibc-2.20/lib64/ld-linux-x86-64.so.2 (0x00007f7e2df6a000)</code></pre>
<p>the reason is that one of the bundled DSOs are actually depending on
libpng12.so.0 (amd64/lib/libIL.so.1), so now one has to patchelf the DSO
instead…</p>
<h3 data-number="2.2" id="fixing-dsos">fixing DSOs</h3>
<p>the FTL binary is a nice example that patchelf does not work for
libGLU.so.1 and libpng12.so.0 because you even though you can try to add
a RPATH for either to the FTL binary, it will never work as the problem
is not the FTL binary but the bundled libraries as ‘lib/libILUT.so.1’ or
‘libILU.so.1’. here an example:</p>
<pre><code>$ patchelf --set-rpath /nix/store/i7ifkqarb8m0w58vs96mqvj0giwll2km-libpng-1.2.51/lib/:/nix/store/93zfs0zzndi7pkjkjxawlafdj8m90kg5-glibc-2.20/lib/:/nix/store/jrhjp66sdfv0pc95dwgdz2sly9hima23-gcc-4.8.4/lib/ FTL/data/amd64/lib/libIL.so.1

$ ldd FTL/data/amd64/lib/libIL.so.1
    linux-vdso.so.1 (0x00007fff207df000)
    libpng12.so.0 =&gt; /nix/store/i7ifkqarb8m0w58vs96mqvj0giwll2km-libpng-1.2.51/lib/libpng12.so.0 (0x00007f5113b04000)
    libstdc++.so.6 =&gt; /nix/store/jrhjp66sdfv0pc95dwgdz2sly9hima23-gcc-4.8.4/lib/libstdc++.so.6 (0x00007f5113800000)
    libm.so.6 =&gt; /nix/store/93zfs0zzndi7pkjkjxawlafdj8m90kg5-glibc-2.20/lib/libm.so.6 (0x00007f51134fd000)
    libc.so.6 =&gt; /nix/store/93zfs0zzndi7pkjkjxawlafdj8m90kg5-glibc-2.20/lib/libc.so.6 (0x00007f5113160000)
    libgcc_s.so.1 =&gt; /nix/store/jrhjp66sdfv0pc95dwgdz2sly9hima23-gcc-4.8.4/lib/libgcc_s.so.1 (0x00007f5112f49000)
    libz.so.1 =&gt; /nix/store/mvjf7dvnpqz9zlvnq4yi86xbc5k9j94r-zlib-1.2.8/lib/libz.so.1 (0x00007f5112d31000)
    /nix/store/93zfs0zzndi7pkjkjxawlafdj8m90kg5-glibc-2.20/lib64/ld-linux-x86-64.so.2 (0x00007f511404b000)</code></pre>
<p>note: beware of ELF 32-bit libs as ‘ldd’ will just silently fail and
tell you there is no lib, altough you added a RPATH pointing to one:</p>
<pre><code>file /nix/store/55nsmmx7jzpm8i664pbj0adik4z6klcv-glu-9.0.0/lib/libGLU.so.1.3.1
/nix/store/55nsmmx7jzpm8i664pbj0adik4z6klcv-glu-9.0.0/lib/libGLU.so.1.3.1: ELF 32-bit LSB shared object, Intel 80386, version 1 (SYSV), dynamically linked, not stripped</code></pre>
<p>note: you need to patch the RPATH from the ‘FTL/’ directory as the
binary expects the the ‘data’ directory to be residing there so you have
to patch the RPATH for the bundled libraries again as we were doing that
wrong in the first place.</p>
<p>finally running the FTL binary:</p>
<pre><code>$ FTL/data/amd64/bin/FTL
Initializing Crash Catcher...
Initializing Video
Video Initialized
Opengl version = 3.0 Mesa 10.2.9
File or path name not found
Error opening resource file
File or path name not found
Error opening resource file
Starting audio library...
BASS_Init: Failed to init BASS Library!
BAS_INIT: 39
File or path name not found
Error opening resource file
Resource Loading Failure (or voluntary quit)!</code></pre>
<p>so we need to make a hack here:</p>
<pre><code>$ ln -s FTL/data/resources
$ FTL/data/amd64/bin/FTL
Initializing Crash Catcher...
Initializing Video
Video Initialized
Opengl version = 3.0 Mesa 10.2.9
Starting audio library...
BASS_Init: Failed to init BASS Library!
BAS_INIT: 39
Resource Preload: 2.530
Loading text....
Initializing animations...
Animations Initialized!
Loading Ship Blueprints....
Blueprints Loaded!
Initializing Sound Data....
Generating world...
Loading achievements...
Loading score file...
Running Game!</code></pre>
<p>and it is working! except that it lacks audio ;P</p>
<h3 data-number="2.3" id="fixing-audio">fixing audio</h3>
<p>there seems to be some problem with a BASS_Init thingy:</p>
<pre><code>$ ./FTL
Loading Arch = amd64
Initializing Crash Catcher...
Initializing Video
Video Initialized
Opengl version = 3.0 Mesa 10.2.9
Starting audio library...
BASS_Init: Failed to init BASS Library!
BAS_INIT: 39
Resource Preload: 2.607
Loading text....
Initializing animations...
Animations Initialized!
Loading Ship Blueprints....
Blueprints Loaded!
Initializing Sound Data....
Generating world...
Loading achievements...
Loading score file...
Running Game!</code></pre>
<p>no clue what is going on, let’s try ‘’strace’’ on the binary (not on
the FTL shell script):</p>
<pre><code>$ strace -e open FTL/data/amd64/bin/FTL
... (much crap)
write(1, &quot;Starting audio library...\n&quot;, 26Starting audio library...
) = 26
open(&quot;/nix/store/zwimkmxsgg5h036knq623hzffnpkc7q5-libass-0.11.1/lib/libasound.so.2&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
open(&quot;/nix/store/nwzpz8lrzry9j223rd84v2r4qs8pc548-libpng-1.2.51/lib/libasound.so.2&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
open(&quot;/nix/store/0jcjjqm8c4gn2jiklq4f518n8hwlfhml-mesa-9.1.3/lib/libasound.so.2&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
open(&quot;/home/joachim/Desktop/ftl/FTL/data/amd64/lib/libasound.so.2&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
open(&quot;/run/opengl-driver/lib/libasound.so.2&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
open(&quot;/nix/store/93zfs0zzndi7pkjkjxawlafdj8m90kg5-glibc-2.20/lib/libasound.so.2&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)
write(1, &quot;BASS_Init: Failed to init BASS L&quot;..., 40BASS_Init: Failed to init BASS Library!
) = 40
write(1, &quot;BAS_INIT: 39\n&quot;, 13BAS_INIT: 39
... (more crap)</code></pre>
<p>so it seems to not find <strong>libasound.so.2</strong> either! so
finally i was using this command:</p>
<pre><code>$ LD_LIBRARY_PATH=/nix/store/qhxaivhds8vahb2wzzhcpm820n32acjh-alsa-lib-1.0.28/lib/:$LD_LIBRARY_PATH FTL/data/amd64/bin/FTL
Initializing Crash Catcher...
Initializing Video
Video Initialized
Opengl version = 3.0 Mesa 10.2.9
Starting audio library...
Audio Initialized!
Resource Preload: 3.802
Loading text....
Initializing animations...
Animations Initialized!
Loading Ship Blueprints....
Blueprints Loaded!
Initializing Sound Data....
Generating world...
Loading achievements...
Loading score file...
Running Game!</code></pre>
<p>note: i don’t have an idea where the libasound.so.2 was introduced
and thus LD_LIBRARY_PATH is the only working solution so far.</p>
<p>however, FTL seems to be quite unstable and sound does not work,
stops working after a while or is just bogus and sounds like noise.
after a while FTL crashes, see this:</p>
<pre><code>$ LD_LIBRARY_PATH=/nix/store/qz8wgnwxmw2jwcd83irff3z0l2lbf1s3-alsa-lib-1.0.28/lib/:$LD_LIBRARY_PATH FTL/data/amd64/bin/FTL
Initializing Crash Catcher...
Initializing Video
Video Initialized
Opengl version = 3.0 Mesa 10.2.9
Starting audio library...
Audio Initialized!
Resource Preload: 3.593
Loading text....
Initializing animations...
Animations Initialized!
Loading Ship Blueprints....
Blueprints Loaded!
Initializing Sound Data....
Generating world...
Loading achievements...
Loading score file...
Running Game!
*** Error in `FTL/data/amd64/bin/FTL&#39;: double free or corruption (!prev): 0x00000000056e0e40 ***
======= Backtrace: =========
/nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libc.so.6(+0x74866)[0x7f6aaeed8866]
/nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libc.so.6(+0x79c16)[0x7f6aaeeddc16]
/nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libc.so.6(+0x7b3d1)[0x7f6aaeedf3d1]
FTL/data/amd64/lib/libbassmix.so(+0x2f76)[0x7f6aafa23f76]
FTL/data/amd64/lib/libbassmix.so(+0x4603)[0x7f6aafa25603]
FTL/data/amd64/lib/libbassmix.so(+0x5cd5)[0x7f6aafa26cd5]
FTL/data/amd64/lib/libbass.so(+0x2b707)[0x7f6ab0ae1707]
FTL/data/amd64/lib/libbass.so(+0x2819f)[0x7f6ab0ade19f]
FTL/data/amd64/lib/libbass.so(+0x2d052)[0x7f6ab0ae3052]
FTL/data/amd64/lib/libbass.so(+0x2d1e5)[0x7f6ab0ae31e5]
/nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libpthread.so.0(+0x6f4a)[0x7f6aaec4cf4a]
/nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/libc.so.6(clone+0x6d)[0x7f6aaef4ed5d]
======= Memory map: ========
003fe000-00400000 rw-p 00000000 fe:01 22413413                           /home/joachim/Desktop/ftl/FTL/data/amd64/bin/FTL
00400000-00766000 r-xp 00002000 fe:01 22413413                           /home/joachim/Desktop/ftl/FTL/data/amd64/bin/FTL
00966000-00967000 rw-p 00368000 fe:01 22413413                           /home/joachim/Desktop/ftl/FTL/data/amd64/bin/FTL
00967000-0097a000 rw-p 00000000 00:00 0 
00b06000-05718000 rw-p 00000000 00:00 0                                  [heap]
7f6a58000000-7f6a58021000 rw-p 00000000 00:00 0 
7f6a58021000-7f6a5c000000 ---p 00000000 00:00 0 
...</code></pre>
<p>cause unknown but other users seem to have this problem as well
;P</p>
<h2 data-number="3" id="alternatives">alternatives</h2>
<h3 data-number="3.1" id="ld_library_path">LD_LIBRARY_PATH</h3>
<p>instead of using patchelf on the FTL binary nor any DSOs, one can
also use LD_LIBRARY_PATH like this:</p>
<pre><code>$ cd FTL/data
$ LD_LIBRARY_PATH=/nix/store/jrhjp66sdfv0pc95dwgdz2sly9hima23-gcc-4.8.4/lib/:/nix/store/fiz0mz982n1m03qzbpvl40n51bvr4b0m-mesa-10.4.5/lib/:amd64/lib:$LD_LIBRARY_PATH /nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/ld-linux-x86-64.so.2 amd64/bin/./FTL</code></pre>
<p>what does this do?</p>
<ol type="1">
<li><p>first we set the <strong>LD_LIBRARY_PATH to include the required
libraries</strong> into the DSO search path,</p></li>
<li><p>afterwards it uses
<strong>/nix/store/6h129q168ahnl2nzw6azr239cba884ng-glibc-2.18/lib/ld-linux-x86-64.so.2,
the dynamic linker</strong>,</p></li>
<li><p>to <strong>execute the binary FTL in directory
amd64/bin/</strong>.</p></li>
</ol>
<p>note: this solution is realy a ‘fast forward’ one and requires only
little effort!</p>
<h3 data-number="3.2" id="ftl.nix">ftl.nix</h3>
<ol type="1">
<li><p>copy <strong>FTL.1.5.13.tar.gz to /tmp</strong></p>
<pre><code> $ cp FTL.1.5.13.tar.gz /tmp</code></pre></li>
<li><p>the <strong>ftl.nix</strong> file contains:</p>
<pre><code> {stdenv, pkgs, lib, makeWrapper, gcc, mesa_glu, path, version }:
 # build this with:
 # 64-bit systems
 #  nix-build -E &#39;with import &lt;nixpkgs&gt; { }; callPackage ./ftl.nix { path=&quot;/tmp/FTL.1.5.13.tar.gz&quot;; version=&quot;1.5.13&quot;; }&#39;
 # 32-bit systems
 #  nix-build -E &#39;with import &lt;nixpkgs&gt; { }; callPackage_i686 ./ftl.nix { path=&quot;/tmp/FTL.1.5.13.tar.gz&quot;; version=&quot;1.5.13&quot;; }&#39;
 let
   arch = if stdenv.system == &quot;x86_64-linux&quot; then &quot;amd64&quot; else &quot;x86&quot;;
   libmapper = val: (map (x: x + &quot;/lib&quot;) val ++ map (x: x + &quot;/lib64&quot;) val); 
   lib_help = if stdenv.system == &quot;x86_64-linux&quot; then &quot;lib64&quot; else &quot;lib&quot;;
 in
 assert (path != null);
 assert (version != null);
 stdenv.mkDerivation rec {
   name = &quot;FTL-${version}&quot;;
   src = path;
   libs = with pkgs; [ stdenv.cc.cc mesa_glu alsaLib zlib ];
   buildInputs = [ makeWrapper ];
   phases = [ &quot;unpackPhase&quot; &quot;installPhase&quot; ];
   installPhase = &#39;&#39;
     mkdir -p &quot;$out/opt/FTL&quot;
     cp -r data &quot;$out/opt/FTL&quot;
     chmod +x &quot;$out/opt/FTL/data/${arch}/bin/FTL&quot;
     interpreter=$(echo ${stdenv.glibc}/${lib_help}/ld-linux*.so.2)
     patchelf --set-interpreter $interpreter &quot;$out/opt/FTL/data/${arch}/bin/FTL&quot;
     patchelf --set-rpath &quot;$out/opt/FTL/data/${arch}/lib&quot; &quot;$out/opt/FTL/data/${arch}/bin/FTL&quot;
     mkdir &quot;$out/bin&quot;
     # using makeWrapper to create a wrapper around the wrapper
     #  --run sets the &#39;working directory&#39;
     #  --prefix adds the LD_LIBRARY_PATH export to the binary
     #  (libmapper libs) generates store location of libraries with lib and lib64 suffixes appended
     makeWrapper &quot;$out/opt/FTL/data/FTL&quot; &quot;$out/bin/ftl&quot; \
         --run &quot;cd $out/opt/FTL/data&quot; \
         --prefix LD_LIBRARY_PATH &#39;:&#39; &quot;${lib.concatStringsSep &quot;:&quot; (libmapper libs)}&quot;;
  &#39;&#39;;
 }</code></pre></li>
<li><ol type="a">
<li><p>build this on a 64-bit system:</p>
<p>nix-build -E ‘with import <nixpkgs> { }; callPackage ./ftl.nix {
path=“/tmp/FTL.1.5.13.tar.gz”; version=“1.5.13”; }’</p></li>
<li><p>build this on a 32-bit system:</p>
<p>nix-build -E ‘with import <nixpkgs> { }; callPackage_i686 ./ftl.nix {
path=“/tmp/FTL.1.5.13.tar.gz”; version=“1.5.13”; }’</p></li>
</ol>
<p><strong>installing it</strong>, this will show something like:</p>
<pre><code> $ nix-build -E &#39;with import &lt;nixpkgs&gt; { }; callPackage /home/joachim/.nixpkgs/ftl.nix { }&#39; 
 these derivations will be built:
   /nix/store/i0wqnwzdhgdlr2a18v8s8aivivzn9qfj-FTL-1.5.13.drv
 building path(s) ‘/nix/store/20k9ch8wafxf8sg7472p2gq1g3d9kjrq-FTL-1.5.13’
 unpacking sources
 unpacking source archive /tmp/FTL.1.5.13.tar.gz
 source root is FTL
 installing
 /nix/store/20k9ch8wafxf8sg7472p2gq1g3d9kjrq-FTL-1.5.13</code></pre></li>
<li><p>now launch the FTL binary with:</p>
<pre><code> $ /nix/store/20k9ch8wafxf8sg7472p2gq1g3d9kjrq-FTL-1.5.13/bin/ftl</code></pre></li>
<li><p>if this works for you, issue this command:</p>
<pre><code> $ nix-env -i /nix/store/20k9ch8wafxf8sg7472p2gq1g3d9kjrq-FTL-1.5.13</code></pre>
<p>note: <strong>this is very important as it will add
/nix/store/20k9ch8wafxf8sg7472p2gq1g3d9kjrq-FTL-1.5.13 to the
GCROOTS</strong> (garbage collector roots) so it won’t be removed when
calling:</p>
<pre><code> $ nix-collect-garbage -d</code></pre>
<p>or</p>
<pre><code> $ nix-store --gc</code></pre></li>
<li><p>you can now issue:</p>
<pre><code> $ rm /tmp/FTL.1.5.13.tar.gz</code></pre></li>
</ol>
<p>and from now on you can just type ‘ftl’ in any shell to start
FTL!</p>
<h2 data-number="4" id="summary">summary</h2>
<p>it can be quite some work to get proprietary software running on
nixos but thanks to the wiki documentation [2], the good examples at [3]
and nix language features like <strong>makeWrapper</strong> it gets much
better.</p>
<p>still waiting for an automation tough ;-)</p>
<h2 data-number="5" id="links">links</h2>
<ul>
<li>[1] <a href="http://www.ftlgame.com/"
class="uri">http://www.ftlgame.com/</a></li>
<li>[2] <a
href="https://nixos.org/wiki/How_to_package_closed-source_software"
class="uri">https://nixos.org/wiki/How_to_package_closed-source_software</a></li>
<li>[3] <a
href="https://nixos.org/wiki/How_to_package_closed-source_software#examples"
class="uri">https://nixos.org/wiki/How_to_package_closed-source_software#examples</a></li>
</ul>

  </div>

</div>

<div id="ArticleSourceCode">

<a href="posts/playing_FTL_on_NIXOS.mdwn" title="posts\playing_FTL_on_NIXOS.mdwn">article source</a>
</div>

</div>

<div id="scrollUp">
<span id="scrollUpBtn" class="glyphiconLink glyphicon glyphicon-chevron-up" aria-hidden="true" title="scroll up"></span>
</div>

<script>
$("#scrollUpBtn").click(function() {
  $("html, body").animate({ scrollTop: 0 }, "slow");
  return false;
});
</script>


<script>
window.onload = function(e){
  anchors.add('h1')
  anchors.add('h2')
  anchors.add('h3')
  anchors.add('h4')
  anchors.add('h5')
}
</script>




<script>
$(document).ready(function() {
  //Calls the tocify method on your HTML div.
  $("#toc").tocify();
});
$("#toc").hover(function() {
  $("#toc").css("z-index", "111")
}, function() {
  $("#toc").css("z-index", "1")
});
</script>



<script>

var shifted = false;

$(window).keyup(function(event) {
    shifted = event.shiftKey;
});

$(window).keydown(function(event) {
  if(event.keyCode == 16){
    shifted = event.shiftKey;
  }
  if (shifted == false) {
      if(event.keyCode == 37){
        $('.glyphicon-chevron-left')[0].click()
      }
      if(event.keyCode == 39){
        $('.glyphicon-chevron-right')[0].click()
      }
  }
});
</script>


<script>
// check if we got served from pankat-server
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
  if (xhr.status == 200) {
    console.log("request to /pankat-server returned status: " + xhr.status + ", so yes we got served from pankat-server");
    $('#draft').css("display", "block");
    $('#roadmap').css("display", "block");
  }
}
}
xhr.open('GET', "/pankat-server", false);
xhr.send(null);
</script>
</body>
</html>
