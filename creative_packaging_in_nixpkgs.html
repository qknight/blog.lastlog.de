<!DOCTYPE html>
<!-- this document is auto-generated from pankat document editor -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head data-article-dst-filename="creative_packaging_in_nixpkgs.html">

<meta charset="utf-8" />
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>creative packaging in nixpkgs</title>

<script src="js/jquery.min.js"></script>

<script src="js/jquery-ui-1.9.1.custom.min.js"></script>
<script src="js/jquery.tocify.min.js"></script>

<link type="text/css" rel="stylesheet" href="css/jquery.tocify.css" />



<script src="js/reconnecting-websocket.min.js"></script>
<script src="js/pankat-websocket.js"></script>
<script src="js/diffDOM.js"></script>


<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
<script src="js/bootstrap.min.js"></script>

<script src="js/anchor.min.js"></script>

<link rel="icon" href="media/favicon.ico" type="image/x-icon" />


<!--[if lt IE 9]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
<![endif]-->
<link rel="stylesheet" href="css/pandoc-kate.css" type="text/css" />
<link rel="stylesheet" href="css/style.css" type="text/css" />

</head>
<body>

<div id="toc"></div>

<!-- menu begins -->
<div class="container">
  <nav class="navbar navbar-default">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">lastlog.de/blog</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="timeline.html"><span class="glyphicon glyphicon-list" aria-hidden="true"></span> timeline</a></li>
        <li><a href="about.html"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> about</a></li>
        <li><a href="/draft" id="draft" style="display: none"><span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span> draft</a></li>
        <li><a href="/draft?article=posts/roadmap.mdwn" id="roadmap" style="display: none"><span class="glyphicon glyphicon glyphicon-road" aria-hidden="true"></span> roadmap</a></li>

      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a title="live updates of article updates on posts/creative_packaging_in_nixpkgs.mdwn" id="websocket" style="display: none"><span id="websocketStatus" class="glyphicon glyphicon-remove" aria-hidden="true"></span> websocket</a></li>
        <!-- <li><a href="#">Login</a></li> -->
      </ul>

      <!--<div id="right">
        <form class="navbar-form navbar-right">
          <div class="form-group">
            <input type="text" class="form-control" placeholder="Search">
          </div>
        </form>
      </div>-->
    </div><!-- /.navbar-collapse -->
  </nav>

<div id="headerAndArticle">


  <div id="headerContainer">
    <header class="header"><span id="articleNavLeft"> <a href="go-webkit2_on_nixos.html"> 
      <span class="glyphiconLink glyphicon glyphicon-chevron-left" aria-hidden="true" title="previous article"> </span> prev. article
    </a> </span><span id="articleNavRight"><a href="NixOS_Chaos_Communication_Camp_2015.html"> 
        next article <span class="glyphiconLink glyphicon glyphicon-chevron-right" aria-hidden="true" title="next article"></span>
    </a> </span></header>
  </div>
  

  <div class="article">
    <h1 id="SiteTitle">creative packaging in nixpkgs</h1>
    <div id="date"><p><span id="lastupdated">21 jun 2015</span></p></div><div id="tags"><p><a href="timeline.html?filter=tag::nixos" class="tagbtn btn btn-primary">nixos</a><a href="timeline.html?filter=tag::linux" class="tagbtn btn btn-primary">linux</a></p></div>
    <p><a href="media/nixos-lores.png"><img src=media/nixos-lores.png alt="" style="float: right" class="noFancy"></a></p>
<h2 data-number="1" id="saleae-logic-analyzer">saleae logic
analyzer</h2>
<p>just discovered an interesting hack for the logic analyzer [1]
software worth sharing! this is about <strong>tricking proprietary
software</strong>:</p>
<p>theory: <strong>if programmers don’t understand the concept of
storing files in $HOME but instead depend on writing data to the same
directory as the binary is in, you are basically doomed on pretty much
every linux distribution</strong>, as this cannot be packaged by
definition. in such situation you can only copy the whole program into
your $HOME or some place else you have write permissions on.</p>
<p><strong>the situation on nixos is even worse, since deploying
proprietary software requires you to use nix by altering the interpreter
and RPATH of the binary and also installing it into the read only
nix-store. using patchelf as i’ve done in the FTL posting [4] is hacky,
complicated and brings stateful breakages on updates as the dependencies
are not seen by the nix garbage collector</strong>.</p>
<p>however, <strong>Bjørn Forsman</strong> made a very cool hack:</p>
<ol type="1">
<li><p>first he patch the software, see [2]:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Patch it</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">patchelf</span> <span class="at">--set-interpreter</span> <span class="st">&quot;</span><span class="va">$(</span><span class="fu">cat</span> <span class="va">$NIX_CC</span>/nix-support/dynamic-linker<span class="va">)</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">$out</span><span class="st">/Logic&quot;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">patchelf</span> <span class="at">--set-rpath</span> <span class="st">&quot;</span><span class="va">${stdenv</span><span class="er">.cc.cc</span><span class="va">}</span><span class="st">/lib:</span><span class="va">${stdenv</span><span class="er">.cc.cc</span><span class="va">}</span><span class="st">/lib64:</span><span class="va">${libPath}</span><span class="st">:</span><span class="dt">\$</span><span class="st">ORIGIN/Analyzers:</span><span class="dt">\$</span><span class="st">ORIGIN&quot;</span> <span class="st">&quot;</span><span class="va">$out</span><span class="st">/Logic&quot;</span></span></code></pre></div></li>
<li><p>then a prepares a shared library:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gcc</span> <span class="at">-shared</span> <span class="at">-fPIC</span> <span class="at">-DOUT</span><span class="op">=</span><span class="dt">\&quot;</span><span class="va">$out</span><span class="dt">\&quot;</span> <span class="st">&quot;</span><span class="va">${</span><span class="er">./preload.c</span><span class="va">}</span><span class="st">&quot;</span> <span class="at">-o</span> <span class="st">&quot;</span><span class="va">$out</span><span class="st">/lib/preload.so&quot;</span> <span class="at">-ldl</span></span></code></pre></div></li>
<li><p>finally he creates a wrapper script:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make wrapper script that uses the LD_PRELOAD library</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> <span class="st">&quot;</span><span class="va">$out</span><span class="st">/bin&quot;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> <span class="st">&quot;</span><span class="va">$out</span><span class="st">/bin/saleae-logic&quot;</span> <span class="op">&lt;&lt; EOF</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="st">#!</span><span class="va">${stdenv</span><span class="er">.shell</span><span class="va">}</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">export LD_PRELOAD=&quot;</span><span class="va">$out</span><span class="st">/lib/preload.so&quot;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">exec &quot;</span><span class="va">$out</span><span class="st">/Logic&quot; &quot;</span><span class="dt">\$</span><span class="st">@&quot;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> a+x <span class="st">&quot;</span><span class="va">$out</span><span class="st">&quot;</span>/bin/saleae-logic</span></code></pre></div></li>
<li><p>the wrapper [3] basically filters fopen and fopen64:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">FILE</span> <span class="op">*</span>fopen<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>pathname<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>mode<span class="op">)</span> <span class="op">{...}</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="dt">FILE</span> <span class="op">*</span>fopen64<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>pathname<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>mode<span class="op">)</span> <span class="op">{...}</span></span></code></pre></div></li>
<li><p>and finally replaces ‘/Settings/settings.xml’ with
‘%s/.saleae-logic-settings.xml’ when it is in the stream!</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>new_path <span class="op">=</span> pathname<span class="op">;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>strcmp<span class="op">(</span>OUT <span class="st">&quot;/Settings/settings.xml&quot;</span><span class="op">,</span> pathname<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    snprintf<span class="op">(</span>buffer<span class="op">,</span> PATH_MAX<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s</span><span class="st">/.saleae-logic-settings.xml&quot;</span><span class="op">,</span> homepath<span class="op">);</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    buffer<span class="op">[</span>PATH_MAX<span class="op">-</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="ch">&#39;</span><span class="sc">\0</span><span class="ch">&#39;</span><span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    new_path <span class="op">=</span> buffer<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></li>
</ol>
<p>this is just <strong>amazing</strong>!</p>
<div class="alert alert-info" role="alert">
<p>this is similar to <a
href="http://blog.lastlog.de/posts/overwriting_glibc_library_functions/">how
linus torvalds repaired the broken flash plugin</a>.</p>
</div>
<h2 data-number="2" id="links">links</h2>
<ul>
<li>[1] <a href="http://saleae.com/"
class="uri">http://saleae.com/</a></li>
<li>[2] <a
href="https://github.com/NixOS/nixpkgs/blob/f3c6827373be102caae5dcbadd31e73ed60fa17f/pkgs/development/tools/misc/saleae-logic/default.nix"
class="uri">https://github.com/NixOS/nixpkgs/blob/f3c6827373be102caae5dcbadd31e73ed60fa17f/pkgs/development/tools/misc/saleae-logic/default.nix</a></li>
<li>[3] <a
href="https://github.com/NixOS/nixpkgs/blob/f3c6827373be102caae5dcbadd31e73ed60fa17f/pkgs/development/tools/misc/saleae-logic/preload.c"
class="uri">https://github.com/NixOS/nixpkgs/blob/f3c6827373be102caae5dcbadd31e73ed60fa17f/pkgs/development/tools/misc/saleae-logic/preload.c</a></li>
<li>[4] <a href="http://blog.lastlog.de/posts/useflags_in_nixos/"
class="uri">http://blog.lastlog.de/posts/useflags_in_nixos/</a></li>
</ul>

  </div>

</div>

<div id="ArticleSourceCode">

<a href="posts/creative_packaging_in_nixpkgs.mdwn" title="posts\creative_packaging_in_nixpkgs.mdwn">article source</a>
</div>

</div>

<div id="scrollUp">
<span id="scrollUpBtn" class="glyphiconLink glyphicon glyphicon-chevron-up" aria-hidden="true" title="scroll up"></span>
</div>

<script>
$("#scrollUpBtn").click(function() {
  $("html, body").animate({ scrollTop: 0 }, "slow");
  return false;
});
</script>


<script>
window.onload = function(e){
  anchors.add('h1')
  anchors.add('h2')
  anchors.add('h3')
  anchors.add('h4')
  anchors.add('h5')
}
</script>




<script>
$(document).ready(function() {
  //Calls the tocify method on your HTML div.
  $("#toc").tocify();
});
$("#toc").hover(function() {
  $("#toc").css("z-index", "111")
}, function() {
  $("#toc").css("z-index", "1")
});
</script>



<script>

var shifted = false;

$(window).keyup(function(event) {
    shifted = event.shiftKey;
});

$(window).keydown(function(event) {
  if(event.keyCode == 16){
    shifted = event.shiftKey;
  }
  if (shifted == false) {
      if(event.keyCode == 37){
        $('.glyphicon-chevron-left')[0].click()
      }
      if(event.keyCode == 39){
        $('.glyphicon-chevron-right')[0].click()
      }
  }
});
</script>


<script>
// check if we got served from pankat-server
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
  if (xhr.status == 200) {
    console.log("request to /pankat-server returned status: " + xhr.status + ", so yes we got served from pankat-server");
    $('#draft').css("display", "block");
    $('#roadmap').css("display", "block");
  }
}
}
xhr.open('GET', "/pankat-server", false);
xhr.send(null);
</script>
</body>
</html>
