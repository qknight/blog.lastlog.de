<!DOCTYPE html>
<!-- this document is auto-generated from pankat document editor -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head data-article-dst-filename="source_distribution_is_broken.html">

<meta charset="utf-8" />
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>source distribution is broken</title>

<script src="js/jquery.min.js"></script>

<script src="js/jquery-ui-1.9.1.custom.min.js"></script>
<script src="js/jquery.tocify.min.js"></script>

<link type="text/css" rel="stylesheet" href="css/jquery.tocify.css" />



<script src="js/reconnecting-websocket.min.js"></script>
<script src="js/pankat-websocket.js"></script>
<script src="js/diffDOM.js"></script>


<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
<script src="js/bootstrap.min.js"></script>

<script src="js/anchor.min.js"></script>

<link rel="icon" href="media/favicon.ico" type="image/x-icon" />


<!--[if lt IE 9]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
<![endif]-->
<link rel="stylesheet" href="css/pandoc-kate.css" type="text/css" />
<link rel="stylesheet" href="css/style.css" type="text/css" />

</head>
<body>

<div id="toc"></div>

<!-- menu begins -->
<div class="container">
  <nav class="navbar navbar-default">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">lastlog.de/blog</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="timeline.html"><span class="glyphicon glyphicon-list" aria-hidden="true"></span> timeline</a></li>
        <li><a href="about.html"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> about</a></li>
        <li><a href="/draft" id="draft" style="display: none"><span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span> draft</a></li>
        <li><a href="/draft?article=posts/roadmap.mdwn" id="roadmap" style="display: none"><span class="glyphicon glyphicon glyphicon-road" aria-hidden="true"></span> roadmap</a></li>

      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a title="live updates of article updates on posts/source_distribution_is_broken.mdwn" id="websocket" style="display: none"><span id="websocketStatus" class="glyphicon glyphicon-remove" aria-hidden="true"></span> websocket</a></li>
        <!-- <li><a href="#">Login</a></li> -->
      </ul>

      <!--<div id="right">
        <form class="navbar-form navbar-right">
          <div class="form-group">
            <input type="text" class="form-control" placeholder="Search">
          </div>
        </form>
      </div>-->
    </div><!-- /.navbar-collapse -->
  </nav>

<div id="headerAndArticle">


  <div id="headerContainer">
    <header class="header"><span id="articleNavLeft"> <a href="nix-language-atlas_nodejs.html"> 
      <span class="glyphiconLink glyphicon glyphicon-chevron-left" aria-hidden="true" title="previous article"> </span> prev. article
    </a> </span><span id="articleNavRight"><a href="nixos_option_search.html"> 
        next article <span class="glyphiconLink glyphicon glyphicon-chevron-right" aria-hidden="true" title="next article"></span>
    </a> </span></header>
  </div>
  

  <div class="article">
    <h1 id="SiteTitle">source distribution is broken</h1>
    <div id="date"><p><span id="lastupdated">10 aug 2014</span></p></div><div id="tags"><p><a href="timeline.html?filter=tag::nixos" class="tagbtn btn btn-primary">nixos</a><a href="timeline.html?filter=tag::lua" class="tagbtn btn btn-primary">lua</a><a href="timeline.html?filter=tag::packagemanager" class="tagbtn btn btn-primary">packagemanager</a><a href="timeline.html?filter=tag::ubuntu" class="tagbtn btn btn-primary">ubuntu</a><a href="timeline.html?filter=tag::usability" class="tagbtn btn btn-primary">usability</a><a href="timeline.html?filter=tag::gentoo" class="tagbtn btn btn-primary">gentoo</a></p></div>
    <p><a href="media/nixos-lores.png"><img src=media/nixos-lores.png alt="" style="float: right" class="noFancy"></a>
<a href="media/prosody.png"><img src=media/prosody.png width="220px" alt="" style="float: right" class="noFancy"></a></p>
<h2 data-number="1" id="motivation">motivation</h2>
<p>source and binary distribution in linux distributions is outdated and
nobody is doing anything [tm].</p>
<h2 data-number="2" id="problem">problem</h2>
<p>today i was packaging prosody [0] for nixos linux and wondered why
lua-socket 2.0.2 wasn’t working as expected. the solution was pretty
easy: it seems that 2.0.2 is just outdated and other distributions as
ubuntu [2] and fedora core [3] do use
<code>[luasocket_3.0~rc1.orig.tar.gz]</code> or
<code>lua-socket-3.0-0.6rc1.fc21.x86_64.rpm</code> respectively. also
both repos don’t state where they got the source code form which is not
only annoying but also dangerous since i now don’t know what
modifications either distribution included!</p>
<p><strong>the issue: [1] does not have a 3.x release nor can i find the
RCS used for development.</strong></p>
<p>diego’s homepage [1] states:</p>
<blockquote>
<p>Last modified by Diego Nehab on</p>
</blockquote>
<blockquote>
<p>Wed Oct 3 02:07:59 BRT 2007</p>
</blockquote>
<p><strong>now, what can we do?</strong></p>
<p>seems like a abandoned project, as so often…</p>
<p>or a different example:</p>
<p><a href="media/source-distribution-broken1.jpeg"><img src=media/source-distribution-broken1.jpeg size=700x alt="nixos-rebuild wanting to pull from github.com" style="float: none"></a></p>
<p>pkgs/development/libraries/minmay/default.nix states:</p>
<pre><code>meta = {
  homepage = &quot;https://github.com/mazhe/minmay&quot;;
  license = stdenv.lib.licenses.lgpl21Plus;
  description = &quot;An XMPP library (forked from the iksemel project)&quot;;
};</code></pre>
<p><strong>mazhe removed minmay</strong>, probably unknowingly that the
nixos distribution still was using this minmay 1.0.0 release from this
repo, see <a href="https://github.com/mazhe/minmay/"
class="uri">https://github.com/mazhe/minmay/</a>. or maybe mazhe didn’t
find any other release of minmay, forked it on github.com and made a
release himself.</p>
<p>in case [1] is abandoned it would be a good idea to:</p>
<ul>
<li>give lua-socket a new home - github.com would be a good idea
IMHO</li>
<li>create a ‘third party release’ on a neutral host like github.com
[4], which does not depend on a distribution</li>
</ul>
<p><strong>in fact, we as a community don’t have any good reliable way
to have access to virtually any project over a large period of
time.</strong></p>
<h2 data-number="3" id="software-distribution-today">software
distribution today</h2>
<p>first, let’s have a look at how software distribution is done in
different linux distributions:</p>
<p><a href="media/source-distribution-broken2.jpeg"><img src=media/source-distribution-broken2.jpeg size=700x alt="source and binary deployment" style="float: none"></a></p>
<p>as shown in the picture above:</p>
<ul>
<li>terminology
<ul>
<li>upstream (usually the developers)</li>
<li>downstream (usually the distributions or users)</li>
<li>midstream (a hypothetical platform between upstream and
downstream)</li>
</ul></li>
<li>we do <strong>not have a common cache for source code</strong></li>
<li>we do <strong>not have a common cache for binaries</strong> (this
would be more complicated, yet possible)</li>
</ul>
<p>and most horrible yet:</p>
<ul>
<li><strong>we still use http GET requests for downloads and not
torrent-like technologies!</strong> most horrible on my android
smartphone when i run out of space i can download new version of a
program, then the installation fails as there is not enough space. next
time it needs to redownload the same application again - WTF?!</li>
</ul>
<h2 data-number="4" id="proposal">proposal</h2>
<p>shipping source/binary data must be redone.</p>
<h3 data-number="4.1" id="shipping-codebinaries">shipping
code/binaries</h3>
<p>i thought about mixing GIT with the torrent technology, so that every
time a new release happens, we just add it to a giant GIT database. i
also propose that we need a meta layer between upstream (the developers)
and downstream (the distributions or endusers). i’d like to call this
midstream and ubuntu’s launchpad, github.com and similar platforms are
pretty close to what midstream would do.</p>
<p>favoured technologies:</p>
<ul>
<li>GIT</li>
<li>obnam [5] (interesting storage concept)</li>
<li>p2p technology (torrent)</li>
<li>GPG</li>
</ul>
<p>wanted features:</p>
<ul>
<li><p>free and open source (FLOSS)</p></li>
<li><p>we could standardize the deployment workflow this way</p></li>
<li><p>easy to scale</p></li>
<li><p>high reliability</p></li>
<li><p>signatures (like debian uses for their packages)</p></li>
<li><p>could be used for ‘binary distribution’ as well (<strong>my focus
here is ‘source deployment’ though</strong>)</p></li>
<li><p>all linux distributions should download from there, instead
directly from upstream. also, if a distribution downloads the code, it
effectively (like in torrents) is now a new node also hosting the code
for as long as users access the code</p></li>
<li><p>we could also host <strong>metadata</strong> and QA there, i
thought about:</p>
<ul>
<li><strong>programming style analysis</strong></li>
<li><strong>code security analysis</strong></li>
<li><strong>reverse lookups</strong> to point out in which distributions
the code is used</li>
<li>store <strong>compile logs</strong>, like: <a
href="http://hydra.nixos.org/project/nixops"
class="uri">http://hydra.nixos.org/project/nixops</a></li>
<li><strong>using GIT directly</strong> with:
<code>git clone --depth 1 --branch &lt;branch&gt; url</code>; this
avoids the usage of tar.gz|bz2|xv completely</li>
<li>project activity, age analysis of overall code</li>
<li>even with a micro payment system or something like bug bounty</li>
</ul></li>
</ul>
<p><strong>i want to outline that there is apt-p2p [6] already, which is
AFAIK used for binary distribution of deb files and not used for source
distribution. i could be wrong though.</strong></p>
<h3 data-number="4.2" id="hashing-the-downloads">hashing the
downloads</h3>
<p>when packaging software for nixos, we do ‘source deployment’ on the
developers machine. when the nix-expression gets into nixpkgs, hydra
will do ‘source deployment’ again. and in most cases hydra will produce
a binary substitute (a NAR file) which is lika a DEB file on ubuntu.</p>
<h4 data-number="4.2.1" id="how-the-hash-is-used">how the hash is
used</h4>
<p>when doing ‘source deployment’, most often we would be using
fetchurl, like below:</p>
<pre><code>src = fetchurl {
  url = &quot;http://downloads.sourceforge.net/project/pdfgrep/${version}/${name}.tar.gz&quot;;
  sha256 = &quot;6e8bcaf8b219e1ad733c97257a97286a94124694958c27506b2ea7fc8e532437&quot;;
};</code></pre>
<p>the given <code>sha256</code> checksum is given by the packager and
every time someone needs to do ‘source deployment’ again, this sha256sum
is used to verify the download given by the <code>url</code>. ebuilds
used by portage on gentoo also implement checksums of downloads this
way.</p>
<h4 data-number="4.2.2" id="the-problem">the problem</h4>
<p>github.com, sourceforge.net and similar sites often create/recreate
containers like .tar.gz or .zip on demand (cause unknown) and therefore
the same container changes hashes over time, altough it still contains
the same files. github.com features a new release system [4] which
addresses this problem.</p>
<p>what we really need:</p>
<ul>
<li>a <strong>container agnostic</strong> hashing system
<ul>
<li><strong>independent of file order</strong> inside the container</li>
<li><strong>independent of compression mechanism</strong></li>
</ul></li>
<li>the checksum mechanism often covers more than we need:
<ul>
<li><strong>on nixos we don’t need file attributes (like creation dates,
owners, groups, permissions)</strong></li>
</ul></li>
</ul>
<h4 data-number="4.2.3" id="possible-solution">possible solution</h4>
<p>since we have to checksum the input for sanity/reproducibility we
can’t just rely on a md5sum/sha256sum of the (compressed?) container.
maybe we could ‘deserialize’ the (compressed?) archives into /nix/store,
then build a NAR file of it and use the NAR’s hash to compare it to
<code>sha256</code> (doing so would remove all superfluous attributes
like (timestamps, ownership, file order in the container, compression
artifacts, compression mechanism, container format issues).</p>
<p>advantage/disatvantage:</p>
<ul>
<li><p>pro:</p>
<ul>
<li>we would <strong>cover all compression and container
technologies</strong> this way</li>
<li>this holds true <strong>for all kind of RCS checkouts</strong> as
well</li>
<li><strong>it would ignore all attributes we are not interested
in</strong> (see list above)</li>
</ul></li>
<li><p>con:</p>
<ul>
<li><strong>this would consume more I/O and CPU time</strong>: to
compute the hash since it would require to re-serialize it again and
compute the hash based on that</li>
</ul></li>
</ul>
<p><strong>note</strong>: a different interesting approach would be to
maintain a list of files per container with respective checksums per
file. the overall checksum would be the sum of all the single
checksums</p>
<h2 data-number="5" id="summary">summary</h2>
<p>we do need distribution agnostic source code storage systems which
scale well and have a high reliability. we also need to alter the way we
build the checksums of source code containers.</p>
<pre><code>update: (18.8.2014) i&#39;ve been talking to aszlig and he mentiones that we have &lt;tarballs.nixos.org&gt; which i didn&#39;t know of so if hydra was able to build the nix expression it would cache the tarball there. but i still don&#39;t think that these tarballs can be accessed by a normal user doing source deployment on his development machine. so in case a tarball changes hashes again, we still have to alter the checksum in the nix expression.</code></pre>
<p><strong>i would love to see more direct GIT usage in nixpkgs, since i
think that doing explicit releases via containers is a waste of human
time.</strong> this should be automated and containers releases should
only be used to make source or binary deployment more efficient.</p>
<h2 data-number="6" id="links">links</h2>
<ul>
<li>[0] <a href="http://prosody.im/"
class="uri">http://prosody.im/</a></li>
<li>[1] <a href="http://w3.impa.br/~diego/software/luasocket/home.html"
class="uri">http://w3.impa.br/~diego/software/luasocket/home.html</a></li>
<li>[2] <a href="http://packages.ubuntu.com/trusty/lua-socket"
class="uri">http://packages.ubuntu.com/trusty/lua-socket</a></li>
<li>[3] <a
href="http://rpm.pbone.net/index.php3/stat/3/srodzaj/1/search/lua-socket"
class="uri">http://rpm.pbone.net/index.php3/stat/3/srodzaj/1/search/lua-socket</a></li>
<li>[4] <a href="https://github.com/blog/1547-release-your-software"
class="uri">https://github.com/blog/1547-release-your-software</a></li>
<li>[5] <a href="http://obnam.org/"
class="uri">http://obnam.org/</a></li>
<li>[6] <a href="http://www.camrdale.org/apt-p2p/"
class="uri">http://www.camrdale.org/apt-p2p/</a></li>
</ul>

  </div>

</div>

<div id="ArticleSourceCode">

<a href="posts/source_distribution_is_broken.mdwn" title="posts\source_distribution_is_broken.mdwn">article source</a>
</div>

</div>

<div id="scrollUp">
<span id="scrollUpBtn" class="glyphiconLink glyphicon glyphicon-chevron-up" aria-hidden="true" title="scroll up"></span>
</div>

<script>
$("#scrollUpBtn").click(function() {
  $("html, body").animate({ scrollTop: 0 }, "slow");
  return false;
});
</script>


<script>
window.onload = function(e){
  anchors.add('h1')
  anchors.add('h2')
  anchors.add('h3')
  anchors.add('h4')
  anchors.add('h5')
}
</script>




<script>
$(document).ready(function() {
  //Calls the tocify method on your HTML div.
  $("#toc").tocify();
});
$("#toc").hover(function() {
  $("#toc").css("z-index", "111")
}, function() {
  $("#toc").css("z-index", "1")
});
</script>



<script>

var shifted = false;

$(window).keyup(function(event) {
    shifted = event.shiftKey;
});

$(window).keydown(function(event) {
  if(event.keyCode == 16){
    shifted = event.shiftKey;
  }
  if (shifted == false) {
      if(event.keyCode == 37){
        $('.glyphicon-chevron-left')[0].click()
      }
      if(event.keyCode == 39){
        $('.glyphicon-chevron-right')[0].click()
      }
  }
});
</script>


<script>
// check if we got served from pankat-server
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
  if (xhr.status == 200) {
    console.log("request to /pankat-server returned status: " + xhr.status + ", so yes we got served from pankat-server");
    $('#draft').css("display", "block");
    $('#roadmap').css("display", "block");
  }
}
}
xhr.open('GET', "/pankat-server", false);
xhr.send(null);
</script>
</body>
</html>
