<!DOCTYPE html>
<!-- this document is auto-generated from pankat document editor -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head data-article-dst-filename="qgraphicsscene_used_as_a_qabstractitemview_iii.html">

<meta charset="utf-8" />
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>qgraphicsscene used as a qabstractitemview iii</title>

<script src="js/jquery.min.js"></script>

<script src="js/jquery-ui-1.9.1.custom.min.js"></script>
<script src="js/jquery.tocify.min.js"></script>

<link type="text/css" rel="stylesheet" href="css/jquery.tocify.css" />



<script src="js/reconnecting-websocket.min.js"></script>
<script src="js/pankat-websocket.js"></script>
<script src="js/diffDOM.js"></script>


<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
<script src="js/bootstrap.min.js"></script>

<script src="js/anchor.min.js"></script>

<link rel="icon" href="media/favicon.ico" type="image/x-icon" />


<!--[if lt IE 9]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
<![endif]-->
<link rel="stylesheet" href="css/pandoc-kate.css" type="text/css" />
<link rel="stylesheet" href="css/style.css" type="text/css" />

</head>
<body>

<div id="toc"></div>

<!-- menu begins -->
<div class="container">
  <nav class="navbar navbar-default">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">lastlog.de/blog</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="timeline.html"><span class="glyphicon glyphicon-list" aria-hidden="true"></span> timeline</a></li>
        <li><a href="about.html"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> about</a></li>
        <li><a href="/draft" id="draft" style="display: none"><span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span> draft</a></li>
        <li><a href="/draft?article=posts/roadmap.mdwn" id="roadmap" style="display: none"><span class="glyphicon glyphicon glyphicon-road" aria-hidden="true"></span> roadmap</a></li>

      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a title="live updates of article updates on posts/qgraphicsscene/qgraphicsscene_used_as_a_qabstractitemview_iii.mdwn" id="websocket" style="display: none"><span id="websocketStatus" class="glyphicon glyphicon-remove" aria-hidden="true"></span> websocket</a></li>
        <!-- <li><a href="#">Login</a></li> -->
      </ul>

      <!--<div id="right">
        <form class="navbar-form navbar-right">
          <div class="form-group">
            <input type="text" class="form-control" placeholder="Search">
          </div>
        </form>
      </div>-->
    </div><!-- /.navbar-collapse -->
  </nav>

<div id="headerAndArticle">


  <div id="headerContainer">
    <header class="header"><span id="articleNavLeft"> <a href="no_more_crashes_after_resuming_from_pm_suspend_iii.html"> 
      <span class="glyphiconLink glyphicon glyphicon-chevron-left" aria-hidden="true" title="previous article"> </span> prev. article
    </a> </span><span id="articleNavRight"><a href="adding_torrent_support_to_your_qt_project.html"> 
        next article <span class="glyphiconLink glyphicon glyphicon-chevron-right" aria-hidden="true" title="next article"></span>
    </a> </span></header>
  </div>
  
      <div id="seriesContainer">
      <a href="timeline.html?filter=series::qgraphicsscene" title="article series qgraphicsscene" class="seriesbtn btn btn-primary">qgraphicsscene</a>
        <header class="seriesHeader">
          <div id="seriesLeft"><a href="qgraphicsscene_used_as_a_qabstractitemview_ii.html"><span class="glyphiconLinkSeries glyphicon glyphicon-chevron-left" aria-hidden="true" title="previous article in series"></span>
            </a>   </div>
          <div id="seriesRight"></div>
        </header>
      </div>

  <div class="article">
    <h1 id="SiteTitle">qgraphicsscene used as a qabstractitemview iii</h1>
    <div id="date"><p><span id="lastupdated">5 oct 2010</span></p></div><div id="tags"><p><a href="timeline.html?filter=tag::qt" class="tagbtn btn btn-primary">qt</a><a href="timeline.html?filter=tag::usability" class="tagbtn btn btn-primary">usability</a><a href="timeline.html?filter=tag::visualization" class="tagbtn btn btn-primary">visualization</a></p></div>
    <h2 data-number="1" id="motiviation">motiviation</h2>
<p>this posting is about using a QGraphicsScene/QGraphicsView with a
QAbstractItemModel. i’ve blogged about this two times, see [1] and [2].
i’ve made progress and i created a few new concepts which might help
<em>you</em> and probably saves a lot of your time.</p>
<p>it is important not to mix the two different Qt concepts: ‘Qt way of
ModelViewController’, so let’s revisit the docs:</p>
<ol type="1">
<li>a <strong>QGraphicsScene/QGraphicsView</strong> has it’s own model
and data storage. one QGraphicsScene (scene) can have several
QGraphicsView(s) (views) attached</li>
<li>a <strong>QAbstractItemModel</strong> is used with
<strong>QTreeView/QTableView</strong> and
<strong>QListView</strong></li>
</ol>
<p>IMPORTANT: <strong>both concepts (1) and (2) can’t be combined
directly - normally (out of the box). what i’m doing here is actually
<em>combining</em> them. as you will see, this can be quite
complicated.</strong></p>
<h2 data-number="2" id="the-basis">the basis</h2>
<p>the first blog posting refers to the automate project, the second to
the ‘spring random map generator’. this posting is mainly about the
‘spring random map generator’. currently the automate codebase is
deprecated and broken. i will eventually fix it. this is how the ‘spring
random map generator’ looks like:</p>
<p><a href="media/spring-random-map-generator-interface61.png"><img src=media/spring-random-map-generator-interface61.png size=800x></a></p>
<h2 data-number="3"
id="so-what-is-new-since-the-last-blog-posting-about-this">so what is
new since the last blog posting about this?</h2>
<ol type="1">
<li>i’m not <strong>inheriting from QAbstractItemView</strong> anymore,
<strong>instead</strong> i’m <strong>using a QGraphicsScene connected to
the QAbstractItemModel</strong> using Qt’s ‘signals&amp;slots’</li>
<li>i’ve developed a <strong>concept for setting up modules and
connections in arbitrary order: </strong>that means you can add a
connection to the QGraphicsScene without having any module! this means
<strong>you can remove QGraphicsItem’s in arbitrary oder as
well</strong> (no more crashes when shutting down the program)</li>
<li>both concepts are implemented in a messanger class:
<strong>GraphicsItemRelay</strong> and a interface:
<strong>GraphcisItemRelayInterface</strong></li>
<li>module properties can be edited using a QTreeView (accessing the
same QAbstractItemModel as the GraphicsScene), using a
QSortFilterProxyModel</li>
<li>how to use graphviz to layout a graph</li>
</ol>
<p>so let’s have a detailed discussion about every of those points.</p>
<h2 data-number="4" id="why-not-inherit-from-qabastractitemview">1. why
not inherit from QAbastractItemView</h2>
<p>since most of the code given by the QAbstractItemView wasn’t used
anyway i removed it (refactoring). now the GraphicsScene is the new view
and functionality is added using direct signal&amp;slot connections.</p>
<ul>
<li>connect( model, SIGNAL(modelReset ()), this, SLOT(reset()));</li>
<li>connect( model, SIGNAL(layoutChanged ()), this,
SLOT(layoutChanged()));</li>
<li>connect( model, SIGNAL(rowsInserted ( const QModelIndex &amp; , int
, int )), this, SLOT(rowsInserted ( const QModelIndex &amp; , int , int
)));</li>
<li>connect( model, SIGNAL(rowsAboutToBeRemoved ( const QModelIndex
&amp; , int , int )), this, SLOT(rowsAboutToBeRemoved ( const
QModelIndex &amp; , int , int )));</li>
<li>connect( model, SIGNAL(dataChanged ( const QModelIndex &amp; , const
QModelIndex &amp; )), this, SLOT(dataChanged ( const QModelIndex &amp; ,
const QModelIndex &amp; )));</li>
</ul>
<p>that is basically all you need to do, if you want to use your
QGraphicsScene as a View on top of a QAbstractItemModel. it’s better to
have less code to care about!</p>
<p><a href="media/graphicssceneasabstractitemview.png"><img src=media/graphicssceneasabstractitemview.png size=700x></a></p>
<h2 data-number="5"
id="addingremoving-modulesconnections-in-arbitrary-order">2.
adding/removing Modules/Connections in arbitrary order</h2>
<p>my first implementation of adding nodes and connections between them
was very limited. see [4], the automate project. as a arrow in the
diagramscene [5] i needed both other QGraphicsItems first in order to
know the source and the destination coordinates to draw a line.</p>
<ul>
<li>that meant on the other hand: one would have to <strong>insert all
nodes first</strong> and then <strong>all connections later</strong>
when a QGraphicsScene/QGraphicsView got populated with items</li>
<li>removing a a QGraphicsScene/QGraphicsView implies the same in
opposite direction: first all connections, later all nodes</li>
</ul>
<p>not doing so would crash the program as the draw routine of the
QGraphicsView, when drawing a connection, would query a QGraphicsItem’s
position (the node) which was simply not there anymore. note: this has a
cyclic dependency:</p>
<ul>
<li>moving a node (QGraphicsItem) does for a connection (QGraphicsItem)
to redraw</li>
<li>removing a connection requires both nodes (QGraphicsItem) to be
there in order to unregister the connection (see previous point)</li>
</ul>
<p>see <a
href="http://github.com/qknight/automate/blob/595770383e34f4bea4beedb99aaa13e6b52b910d/src/GraphicsView/SceneItem_Node.cpp"
class="uri">http://github.com/qknight/automate/blob/595770383e34f4bea4beedb99aaa13e6b52b910d/src/GraphicsView/SceneItem_Node.cpp</a>:</p>
<pre><code>QVariant SceneItem_Node::itemChange ( GraphicsItemChange change, const QVariant &amp;value ) {</code></pre>
<p>to sum up: to reduce code and complexity it is important to make
insertion and deletion in arbitrary order, see (3) how i did it.</p>
<h2 data-number="6"
id="the-graphicsitemrelay-and-the-graphicsitemrelayinterface">3. the
GraphicsItemRelay and the GraphicsItemRelayInterface</h2>
<p>since problem (2) only requires the position of an object i decided
to implement a messenger class:</p>
<ul>
<li><a
href="http://github.com/qknight/springrts.com-random-map-generator/blob/f4e8eb99f4e0b0c22491a2c8f608b6fd1a83ebd6/src/frontend/GraphicsItemRelayInterface.cpp"
class="uri">http://github.com/qknight/springrts.com-random-map-generator/blob/f4e8eb99f4e0b0c22491a2c8f608b6fd1a83ebd6/src/frontend/GraphicsItemRelayInterface.cpp</a></li>
<li><a
href="http://github.com/qknight/springrts.com-random-map-generator/blob/f4e8eb99f4e0b0c22491a2c8f608b6fd1a83ebd6/src/frontend/GraphicsItemRelayInterface.h"
class="uri">http://github.com/qknight/springrts.com-random-map-generator/blob/f4e8eb99f4e0b0c22491a2c8f608b6fd1a83ebd6/src/frontend/GraphicsItemRelayInterface.h</a></li>
<li><a
href="http://github.com/qknight/springrts.com-random-map-generator/blob/f4e8eb99f4e0b0c22491a2c8f608b6fd1a83ebd6/src/frontend/GraphicsItemRelay.cpp"
class="uri">http://github.com/qknight/springrts.com-random-map-generator/blob/f4e8eb99f4e0b0c22491a2c8f608b6fd1a83ebd6/src/frontend/GraphicsItemRelay.cpp</a></li>
<li><a
href="http://github.com/qknight/springrts.com-random-map-generator/blob/f4e8eb99f4e0b0c22491a2c8f608b6fd1a83ebd6/src/frontend/GraphicsItemRelay.h"
class="uri">http://github.com/qknight/springrts.com-random-map-generator/blob/f4e8eb99f4e0b0c22491a2c8f608b6fd1a83ebd6/src/frontend/GraphicsItemRelay.h</a></li>
</ul>
<p>the concept might look quite complex but it works great as one can
remove connections or modules (ports) in arbitrary order, just what i
discussed in (2).</p>
<h2 data-number="7" id="module-properties-and-a-qtreeview">4. module
properties and a QTreeView</h2>
<p>in the last posting [2] i wondered how to implement properties
without adding yet another hierarchy layer. it seems it can be done by
doing so. see the image in this posting: it features two different views
using the same QAbstractItemModel.</p>
<p>again, what was the problem?</p>
<ul>
<li>a list of items should be editable just as done in ‘qtdesigner’
where you have a nice list on the right side hosting QObject
attributes</li>
<li>every element in the list should be accessed via a QModelIndex so
that the model is used to set/get the values</li>
<li>every time a property changes the view should be updated as the
rendered image might (very likely) change as the parameter influence the
image rendering process</li>
</ul>
<p>the problem was with the hierarchy layer:</p>
<ul>
<li>rootitem - module - port - connection</li>
</ul>
<p>which was extended by:</p>
<ul>
<li>rootitem - module - port - connection</li>
<li>rootitem - module - property</li>
</ul>
<p>as there are two different views:</p>
<ul>
<li>QTreeView: used to make properties editable</li>
<li>QGraphicsScene/QGraphicsView to visualize the graph</li>
</ul>
<p>that means we have to take care for the third layer as there can be a
port or a property.</p>
<p>the <strong>QGraphicsScene/QGraphicsView ignores properties</strong>.
as it simply ignores them. the <strong>QTreeView would render
ports</strong> but to avoid that one can use a <strong>QFilterProxyModel
which filters out all ports</strong> (and all childs of them). this way
only modules and properties are there.</p>
<h2 data-number="8" id="how-to-use-graphiviz-to-layout-a-graph">5. how
to use graphiviz to layout a graph</h2>
<p>i always wanted to use graphiviz to layout my automate. i’ve found a
implementation at [7] which describes how to do so. i did not find the
time yet to use that code. maybe i find the time in the future.</p>
<h2 data-number="9" id="links">links</h2>
<ul>
<li>[1] <a
href="http://invalidmagic.wordpress.com/2009/12/10/qgraphicsscene-used-as-a-qabstractitemmodel/"
class="uri">http://invalidmagic.wordpress.com/2009/12/10/qgraphicsscene-used-as-a-qabstractitemmodel/</a></li>
<li>[2] <a
href="http://invalidmagic.wordpress.com/2010/02/02/qgraphicsscene-used-as-a-qabstractitemview-ii/"
class="uri">http://invalidmagic.wordpress.com/2010/02/02/qgraphicsscene-used-as-a-qabstractitemview-ii/</a></li>
<li>[3] <a
href="http://github.com/qknight/springrts.com-random-map-generator"
class="uri">http://github.com/qknight/springrts.com-random-map-generator</a></li>
<li>[4] <a href="http://github.com/qknight/automate"
class="uri">http://github.com/qknight/automate</a></li>
<li>[5] <a
href="http://doc.trolltech.com/4.5/graphicsview-diagramscene.html"
class="uri">http://doc.trolltech.com/4.5/graphicsview-diagramscene.html</a></li>
<li>[6] <a
href="http://labs.trolltech.com/blogs/2008/10/24/itemviews-the-next-generation/"
class="uri">http://labs.trolltech.com/blogs/2008/10/24/itemviews-the-next-generation/</a></li>
<li>[7] <a href="http://mupuf.org/blog/article/34/"
class="uri">http://mupuf.org/blog/article/34/</a></li>
</ul>

  </div>

</div>

<div id="ArticleSourceCode">

<a href="posts/qgraphicsscene/qgraphicsscene_used_as_a_qabstractitemview_iii.mdwn" title="posts\qgraphicsscene\qgraphicsscene_used_as_a_qabstractitemview_iii.mdwn">article source</a>
</div>

</div>

<div id="scrollUp">
<span id="scrollUpBtn" class="glyphiconLink glyphicon glyphicon-chevron-up" aria-hidden="true" title="scroll up"></span>
</div>

<script>
$("#scrollUpBtn").click(function() {
  $("html, body").animate({ scrollTop: 0 }, "slow");
  return false;
});
</script>


<script>
window.onload = function(e){
  anchors.add('h1')
  anchors.add('h2')
  anchors.add('h3')
  anchors.add('h4')
  anchors.add('h5')
}
</script>




<script>
$(document).ready(function() {
  //Calls the tocify method on your HTML div.
  $("#toc").tocify();
});
$("#toc").hover(function() {
  $("#toc").css("z-index", "111")
}, function() {
  $("#toc").css("z-index", "1")
});
</script>



<script>

var shifted = false;

$(window).keyup(function(event) {
    shifted = event.shiftKey;
});

$(window).keydown(function(event) {
  if(event.keyCode == 16){
    shifted = event.shiftKey;
  }
  if (shifted == false) {
      if(event.keyCode == 37){
        $('.glyphicon-chevron-left')[0].click()
      }
      if(event.keyCode == 39){
        $('.glyphicon-chevron-right')[0].click()
      }
  }
});
</script>


<script>
// check if we got served from pankat-server
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
  if (xhr.status == 200) {
    console.log("request to /pankat-server returned status: " + xhr.status + ", so yes we got served from pankat-server");
    $('#draft').css("display", "block");
    $('#roadmap').css("display", "block");
  }
}
}
xhr.open('GET', "/pankat-server", false);
xhr.send(null);
</script>
</body>
</html>
