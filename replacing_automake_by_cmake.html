<!DOCTYPE html>
<!-- this document is auto-generated from pankat document editor -->
<html xmlns="http://www.w3.org/1999/xhtml">

<head data-article-dst-filename="replacing_automake_by_cmake.html">

<meta charset="utf-8" />
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>replacing automake by cmake</title>

<script src="js/jquery.min.js"></script>

<script src="js/jquery-ui-1.9.1.custom.min.js"></script>
<script src="js/jquery.tocify.min.js"></script>

<link type="text/css" rel="stylesheet" href="css/jquery.tocify.css" />



<script src="js/reconnecting-websocket.min.js"></script>
<script src="js/pankat-websocket.js"></script>
<script src="js/diffDOM.js"></script>


<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css" />
<script src="js/bootstrap.min.js"></script>

<script src="js/anchor.min.js"></script>

<link rel="icon" href="media/favicon.ico" type="image/x-icon" />


<!--[if lt IE 9]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
<![endif]-->
<link rel="stylesheet" href="css/pandoc-kate.css" type="text/css" />
<link rel="stylesheet" href="css/style.css" type="text/css" />

</head>
<body>

<div id="toc"></div>

<!-- menu begins -->
<div class="container">
  <nav class="navbar navbar-default">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">lastlog.de/blog</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li><a href="timeline.html"><span class="glyphicon glyphicon-list" aria-hidden="true"></span> timeline</a></li>
        <li><a href="about.html"><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span> about</a></li>
        <li><a href="/draft" id="draft" style="display: none"><span class="glyphicon glyphicon-folder-open" aria-hidden="true"></span> draft</a></li>
        <li><a href="/draft?article=posts/roadmap.mdwn" id="roadmap" style="display: none"><span class="glyphicon glyphicon glyphicon-road" aria-hidden="true"></span> roadmap</a></li>

      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a title="live updates of article updates on posts/replacing_automake_by_cmake.mdwn" id="websocket" style="display: none"><span id="websocketStatus" class="glyphicon glyphicon-remove" aria-hidden="true"></span> websocket</a></li>
        <!-- <li><a href="#">Login</a></li> -->
      </ul>

      <!--<div id="right">
        <form class="navbar-form navbar-right">
          <div class="form-group">
            <input type="text" class="form-control" placeholder="Search">
          </div>
        </form>
      </div>-->
    </div><!-- /.navbar-collapse -->
  </nav>

<div id="headerAndArticle">


  <div id="headerContainer">
    <header class="header"><span id="articleNavLeft"> <a href="running_the_nix_package_manager_in_a_prefix_as_the_home_directory.html"> 
      <span class="glyphiconLink glyphicon glyphicon-chevron-left" aria-hidden="true" title="previous article"> </span> prev. article
    </a> </span><span id="articleNavRight"><a href="bringing_nix_to_its_limits.html"> 
        next article <span class="glyphiconLink glyphicon glyphicon-chevron-right" aria-hidden="true" title="next article"></span>
    </a> </span></header>
  </div>
  

  <div class="article">
    <h1 id="SiteTitle">replacing automake by cmake</h1>
    <div id="date"><p><span id="lastupdated">28 jan 2011</span></p></div><div id="tags"><p><a href="timeline.html?filter=tag::cmake" class="tagbtn btn btn-primary">cmake</a><a href="timeline.html?filter=tag::linux" class="tagbtn btn btn-primary">linux</a><a href="timeline.html?filter=tag::packagemanager" class="tagbtn btn btn-primary">packagemanager</a><a href="timeline.html?filter=tag::technology" class="tagbtn btn btn-primary">technology</a><a href="timeline.html?filter=tag::usability" class="tagbtn btn btn-primary">usability</a><a href="timeline.html?filter=tag::nixos" class="tagbtn btn btn-primary">nixos</a></p></div>
    <p><a href="media/nixos-lores.png"><img src=media/nixos-lores.png alt="" style="float: right"></a></p>
<h2 data-number="1" id="motivation">motivation</h2>
<p>as i’ve been experimenting with nix [1] (cross platform, cross
distribution package manager) i hit a lot of issues in the automake
based buildsystem. this post is about what motivated me to replace
automake with cmake. it also coveres issues i had to solve. the
nix-0.16-cmake project can be found at [2].</p>
<h2 data-number="2" id="found-autotools-issues">found autotools
issues</h2>
<p>i’ve found quite many issues in the autotools build script of nix. i
don’t know if they are specific to nix or to autotools. however: i don’t
like autotools because:</p>
<ul>
<li><p>they are <strong>very complex to maintain</strong></p></li>
<li><p>complicated in usage, <strong>what parameters do what</strong>?
you are literally ‘<strong>flooded</strong>’ by typing:
<strong>./configure –help</strong></p></li>
<li><p>there are a <strong>million differnt versions of
automake</strong> probably all are installed on my gentoo system!
why?</p></li>
<li><p>all your <strong>directories</strong> get <strong>filled with
these strange files</strong>: config.status, configure.ac, Makefile.am,
Makefile.in, …</p></li>
<li><p>does autotools support “out of source” builds? never seen it
yet.</p></li>
</ul>
<p>in contrast cmake:</p>
<ul>
<li><p><strong>cmake</strong> has a very <strong>easy to lern
syntax</strong></p></li>
<li><p>i like the <strong>colored build system</strong></p></li>
</ul>
<p>some may say i might a bit biased towards cmake, so let’s consider
nix-specific issues only:</p>
<ul>
<li><p>prefix installation does not work (as normal user) if not passing
<strong>–localstatedir=</strong>path/state this is <strong>not
listed</strong> in any** docu,** nor <strong>./configure –help update:
(</strong>it is actually listed in the documentation, see section: Quick
Start, point 1<strong>) </strong></p></li>
<li><p>the build system does not warn, when not using
<strong>–with-store-dir=/nix/store</strong>, that all software has to be
recompiled it is listed in the documentation tough but this screwed some
of my first builds</p></li>
<li><p>when using <strong>–with-store-dir=/nix/ </strong>it will chmod
/nix/ to mode 1777 instead of adding
<strong>/nix/store</strong></p></li>
<li><p>running <strong>./configure is slow</strong></p></li>
<li><p>if you <strong>forget to run ./bootstrap.sh</strong> you still
can build &amp; install nix but it <strong>does not work
properly</strong></p></li>
<li><p><strong>–with-store-dir= and –localstatedir= </strong>will always
<strong>overwrite –prefix</strong> by default this implies they need to
be always used in a ‘pure prefix’ installation</p></li>
</ul>
<p>i might very likely hit some other issues but i don’t remember them.
if this list is not enough for you, just read why the kde developers use
cmake instead of autools/scons today.</p>
<p><strong>NOTE:</strong> this is not a criticism about upstream (the
nix developers). i do like their work very much. in case they do not
want to use cmake, i’m fine with that. they can use my changelog to fix
issues associated with the automake issues i pointed out.</p>
<h2 data-number="3" id="how-to-replace-autotools-by-cmake">how to
replace autotools by cmake</h2>
<p>one of the first things was to install nix 0.16 with autotools:</p>
<ul>
<li><p>cd nix</p></li>
<li><p>rm -Rf nix-0.16</p></li>
<li><p>tar xf nix-0.16.tar</p></li>
<li><p>cd nix-0.16/</p></li>
<li><p>./bootstrap.sh</p></li>
<li><p>./configure –prefix=<span
class="math inline"><em>m</em><em>P</em><em>R</em><em>E</em><em>F</em><em>I</em><em>X</em> −  − <em>l</em><em>o</em><em>c</em><em>a</em><em>l</em><em>s</em><em>t</em><em>a</em><em>t</em><em>e</em><em>d</em><em>i</em><em>r</em>=</span>mPREFIX/state
–with-store-dir=/nix/store</p></li>
<li><p>make</p></li>
<li><p>make install</p></li>
</ul>
<p>i <strong>copied the shell output to a text file </strong>to have an
idea what to do when. next i started from scratch with a top-level
‘CMakeLists.txt’.</p>
<ul>
<li><p>as** cmake is hierarchical**, start small with an ever increasing
directory coverage</p></li>
<li><p>make only <strong>small changes </strong></p></li>
<li><p><strong>start with a build environment</strong>, later
<strong>create the installer</strong> and** finally do QA**</p></li>
<li><p>install into the same prefix, say /tmp/nix-prefix, move the fils
apart and check both directories for differences</p>
<pre><code>#!/bin/bash

DIRA=/tmp/nix-unified
DIRB=/tmp/nix-autotools

find $DIRA | sed &quot;s%${DIRA}%%g&quot; | sort &gt; /tmp/fileA
find $DIRB | sed &quot;s%${DIRB}%%g&quot; | sort &gt; /tmp/fileB

echo &quot;files in both dirs are filtered by -3&quot;
echo &quot;--------------------------------------------&quot;
echo &quot;$DIRA&quot;
echo &quot;  $DIRB&quot;
echo &quot;--------------------------------------------&quot;
comm &lt;(cat /tmp/fileA) &lt;(cat /tmp/fileB) -3</code></pre></li>
</ul>
<p>i’ve also <strong>created scripts to automate various installation
scenarios</strong> for <strong>automated testing</strong>.</p>
<h2 data-number="4" id="interesting-findings">interesting findings</h2>
<ul>
<li><p>automake/cmake supports <strong>RPATH</strong> build of binaries,
see [3] that helps to make** binaries find their associated libraries**
(libfoo.so) without having to alter the LD_LIBRARY_PATH. this way you
can execute the program either while it is in your ‘out of source’ build
directory (interesting for developers) or after you typed ‘make
install’.</p></li>
<li><p>use <strong>DEFINES</strong> instead of
<strong>CONFIGURE_FILE</strong> where possible especially to** pass the
version number variable** from the CMakeLists.txt <strong>to your c/c++
code</strong></p></li>
<li><p><strong>DESTDIR</strong> builds, see [4]. this is a very nice
feature for ‘downstream’ (distributions) to integrate software into
their system</p></li>
</ul>
<h2 data-number="5" id="cmake-pitfalls">cmake pitfalls</h2>
<ul>
<li><p>always check your variable names, i had a bug which cost me a few
hours where a cmake variable was wrong: CMAKE_TR_PAT<strong>H
</strong>was CMAKE_TR_PAT<strong>h this resulted in a silent fail.
</strong>in c/c++ one would get a error of using an undefined variable,
why not here?<strong> </strong></p></li>
<li><p>when trying to <strong>add ‘broken’ symlinks</strong> (which
won’t work as you passed the wrong directories) <strong>cmake tends to
pass silently</strong></p></li>
<li><p>when adding <strong>PERMISSIONS</strong> to a file, cmake might
break when the file is not readable (anymore). i don’t know the cause
for this, maybe a cmake issue. so instead of <strong>PERMISSIONS
OWNER_EXECUTE GROUP_EXECUTE WORLD_EXECUTE</strong> better do:
<strong>PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE GROUP_READ
GROUP_EXECUTE WORLD_READ WORLD_EXECUTE</strong></p></li>
</ul>
<p>the result of using the <strong>wrong PERMISSONS</strong> was:</p>
<blockquote>
<p>CMake Error at scripts/cmake_install.cmake:40 (FILE): file INSTALL
cannot set permissions on “/tmp/nix-cmake/bin/nix-collect-garbage” Call
Stack (most recent call first): cmake_install.cmake:175 (INCLUDE)</p>
</blockquote>
<ul>
<li><p><strong>CMAKE_INSTALL_RPATH must match your
library-directory</strong> (where your libraries are)! i forgot to add
the subdirectory once and the effect was that the binaries were not
executable, moking about not finding libmain.</p></li>
<li><p><strong>check</strong> that all scripts/program which should be
executable are actually ‘installed’ as executable <strong>ls -la
–color=auto</strong> helps a lot here</p></li>
<li><p>check file modes in general, use this: find . -name *.pl -exec ls
-la –color=auto {} +</p></li>
</ul>
<h2 data-number="6" id="current-status">current status</h2>
<p>i’ve invested quite some time now and still the project isn’t
finished. it’s usually very small issues as discussed in the pitfalls
section already. since this is my first major cmake integration i
expected this. see [5] for further details.</p>
<h2 data-number="7" id="links">links</h2>
<ul>
<li>[1] <a href="http://nixos.org/nix/"
class="uri">http://nixos.org/nix/</a></li>
<li>[2] <a href="https://github.com/qknight/nix-0.16-cmake/"
class="uri">https://github.com/qknight/nix-0.16-cmake/</a></li>
<li>[3] <a href="http://www.cmake.org/Wiki/CMake_RPATH_handling"
class="uri">http://www.cmake.org/Wiki/CMake_RPATH_handling</a></li>
<li>[4] <a href="http://www.dwheeler.com/essays/automating-destdir.html"
class="uri">http://www.dwheeler.com/essays/automating-destdir.html</a></li>
<li>[5] <a
href="https://github.com/qknight/nix-0.16-cmake/blob/master/README.cmake"
class="uri">https://github.com/qknight/nix-0.16-cmake/blob/master/README.cmake</a></li>
</ul>

  </div>

</div>

<div id="ArticleSourceCode">

<a href="posts/replacing_automake_by_cmake.mdwn" title="posts\replacing_automake_by_cmake.mdwn">article source</a>
</div>

</div>

<div id="scrollUp">
<span id="scrollUpBtn" class="glyphiconLink glyphicon glyphicon-chevron-up" aria-hidden="true" title="scroll up"></span>
</div>

<script>
$("#scrollUpBtn").click(function() {
  $("html, body").animate({ scrollTop: 0 }, "slow");
  return false;
});
</script>


<script>
window.onload = function(e){
  anchors.add('h1')
  anchors.add('h2')
  anchors.add('h3')
  anchors.add('h4')
  anchors.add('h5')
}
</script>




<script>
$(document).ready(function() {
  //Calls the tocify method on your HTML div.
  $("#toc").tocify();
});
$("#toc").hover(function() {
  $("#toc").css("z-index", "111")
}, function() {
  $("#toc").css("z-index", "1")
});
</script>



<script>

var shifted = false;

$(window).keyup(function(event) {
    shifted = event.shiftKey;
});

$(window).keydown(function(event) {
  if(event.keyCode == 16){
    shifted = event.shiftKey;
  }
  if (shifted == false) {
      if(event.keyCode == 37){
        $('.glyphicon-chevron-left')[0].click()
      }
      if(event.keyCode == 39){
        $('.glyphicon-chevron-right')[0].click()
      }
  }
});
</script>


<script>
// check if we got served from pankat-server
var xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
if (xhr.readyState == XMLHttpRequest.DONE) {
  if (xhr.status == 200) {
    console.log("request to /pankat-server returned status: " + xhr.status + ", so yes we got served from pankat-server");
    $('#draft').css("display", "block");
    $('#roadmap').css("display", "block");
  }
}
}
xhr.open('GET', "/pankat-server", false);
xhr.send(null);
</script>
</body>
</html>
